<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Dashboard - ElivateOne</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/dashboard.css?v=4.0">
    <link rel="stylesheet" href="css/space.css">
    <link rel="stylesheet" href="css/system-performance.css">
    <link rel="stylesheet" href="css/schedule-modal.css">
    <link rel="stylesheet" href="css/calendar-modal.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Global Loader -->
    <div class="global-loader" id="globalLoader">
        <div class="loader-content">
            <i class="fa-solid fa-spinner loader-icon"></i>
            <div class="loader-text">Loading...</div>
        </div>
    </div>

    <script>
        // Check if setup is complete, redirect to setup if not
        if (!localStorage.getItem('bayyti_setup_complete')) {
            window.location.href = 'setup.html';
        }
    </script>

    <!-- Red Header Bar -->
    <header class="top-header">
        <div class="header-container">
            <button class="mobile-menu-btn" id="mobile-menu-btn" aria-label="Menu">
                <i class="fa-solid fa-ellipsis-vertical"></i>
            </button>
            <div class="header-left">
                <div class="logo logo-setup-container">
                    <img src="logosetup.png" alt="BAYYTI Logo" class="logo-setup-image">
                </div>
            </div>
            <div class="header-center">
                <h1 class="project-title">Space Dashboard <strong>ElivateOne</strong></h1>
                <div class="header-datetime" id="header-datetime">
                    <i class="fa-solid fa-clock"></i>
                    <span id="header-time">--:--</span>
                    <span class="datetime-separator">•</span>
                    <span id="header-date">--- --, ----</span>
                </div>
            </div>
            <div class="header-right">
                <button class="header-icon-btn" id="alertBtn" title="Alerts & Warnings">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                    <span class="alert-counter" id="alertCounter">0</span>
                </button>
                <button class="header-icon-btn" id="notificationBtn" title="System Notifications">
                    <i class="fa-solid fa-bell"></i>
                    <span class="notification-badge" id="notificationBadge">0</span>
                </button>
                <button class="header-icon-btn" id="updateBtnMain" title="Check for system updates">
                    <i class="fa-solid fa-rotate"></i>
                    <span class="update-indicator" id="updateIndicator"></span>
                </button>
                <button class="header-icon-btn drag-toggle-btn" id="dragToggleBtn" title="Enable/Disable Drag & Drop">
                    <i class="fa-solid fa-grip-vertical"></i>
                </button>
                <a href="index.html" class="header-icon-btn" title="Classic Dashboard">
                    <i class="fa-solid fa-gauge"></i>
                </a>
                <a href="analytics.html" class="header-icon-btn" title="View Analytics Dashboard">
                    <i class="fa-solid fa-chart-line"></i>
                </a>
                <a href="emergency.html" class="header-icon-btn" title="Emergency Controls" style="background: rgba(220, 53, 69, 0.2);">
                    <i class="fa-solid fa-fire-extinguisher"></i>
                </a>
                <a href="hardware.html" class="header-icon-btn" title="Hardware Schema">
                    <i class="fa-solid fa-microchip"></i>
                </a>
                <a href="controls.html" class="header-icon-btn" title="User & System Controls">
                    <i class="fa-solid fa-sliders"></i>
                </a>
                <a href="ai.html" class="header-icon-btn" title="AI Model Testing">
                    <i class="fa-solid fa-brain"></i>
                </a>
                <a href="support.html" class="header-icon-btn" title="Support">
                    <i class="fa-solid fa-circle-question"></i>
                </a>
                <a href="faq.html" class="header-icon-btn" title="FAQ">
                    <i class="fa-solid fa-book"></i>
                </a>
                <a href="#" class="header-icon-btn" id="setup-link" aria-label="Return to Setup" title="Return to Setup">
                    <i class="fa-solid fa-gear"></i>
                </a>
                <button class="header-icon-btn reboot-btn" id="rebootBtn" title="Reboot System">
                    <i class="fa-solid fa-power-off"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Mobile Sidebar Menu -->
    <div class="mobile-sidebar" id="mobile-sidebar">
        <div class="sidebar-overlay" id="sidebar-overlay"></div>
        <div class="sidebar-content">
            <div class="sidebar-header">
                <button class="sidebar-close" id="sidebar-close" aria-label="Close Menu">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <nav class="sidebar-nav">
                <a href="index.html" class="sidebar-item" title="Dashboard">
                    <i class="fa-solid fa-gauge"></i>
                </a>
                <a href="space.html" class="sidebar-item active" title="Space Dashboard">
                    <i class="fa-solid fa-rocket"></i>
                </a>
                <a href="analytics.html" class="sidebar-item" title="Analytics">
                    <i class="fa-solid fa-chart-line"></i>
                </a>
                <a href="emergency.html" class="sidebar-item" title="Emergency Controls">
                    <i class="fa-solid fa-fire-extinguisher"></i>
                </a>
                <a href="hardware.html" class="sidebar-item" title="Hardware Schema">
                    <i class="fa-solid fa-microchip"></i>
                </a>
                <a href="controls.html" class="sidebar-item" title="User & System Controls">
                    <i class="fa-solid fa-sliders"></i>
                </a>
                <a href="ai.html" class="sidebar-item" title="AI Model Testing">
                    <i class="fa-solid fa-brain"></i>
                </a>
                <a href="support.html" class="sidebar-item" title="Support">
                    <i class="fa-solid fa-circle-question"></i>
                </a>
                <button class="sidebar-item" id="rebootBtnMobile" title="Reboot System">
                    <i class="fa-solid fa-power-off"></i>
                </button>
            </nav>
        </div>
    </div>

    <!-- Main Content with Sidebar Layout -->
    <div class="space-layout-container">
        <!-- Irrigation Timer Sidebar -->
        <aside class="irrigation-sidebar-space">
            <div class="irrigation-header-space">
                <i class="fa-solid fa-droplet"></i>
                <h3>Irrigation Time</h3>
            </div>
            
            <div class="circular-progress-container-space">
                <svg class="circular-progress-space" viewBox="0 0 200 200">
                    <circle class="progress-bg-space" cx="100" cy="100" r="85"></circle>
                    <circle class="progress-bar-space" cx="100" cy="100" r="85" id="irrigation-progress-circle-space"></circle>
                </svg>
                <div class="progress-content-space">
                    <div class="progress-value-space" id="irrigation-minutes-space">0</div>
                    <div class="progress-label-space">Minutes</div>
                    <div class="progress-sublabel-space">Today</div>
                </div>
            </div>
            
            <div class="irrigation-divider-space"></div>
            
            <div class="irrigation-stats-space">
                <div class="stat-item-space">
                    <div class="stat-icon-space">
                        <i class="fa-solid fa-valve"></i>
                    </div>
                    <div class="stat-info-space">
                        <div class="stat-label-space">Valve Opens</div>
                        <div class="stat-value-space" id="valve-open-count-space">0</div>
                    </div>
                </div>
                
                <div class="stat-item-space">
                    <div class="stat-icon-space">
                        <i class="fa-solid fa-clock"></i>
                    </div>
                    <div class="stat-info-space">
                        <div class="stat-label-space">Avg Duration</div>
                        <div class="stat-value-space" id="avg-duration-space">0 min</div>
                    </div>
                </div>
                
                <div class="stat-item-space">
                    <div class="stat-icon-space">
                        <i class="fa-solid fa-water"></i>
                    </div>
                    <div class="stat-info-space">
                        <div class="stat-label-space">Water Used</div>
                        <div class="stat-value-space" id="water-used-today-space">0 L</div>
                    </div>
                </div>
            </div>
            
            <div class="irrigation-status-space" id="irrigation-status-space">
                <div class="status-indicator-space status-idle"></div>
                <span>Idle</span>
            </div>
        </aside>

        <div class="space-main-content">
        <!-- Page Title -->
        <div class="page-title-section">
            <div class="page-title-icon">
                <i class="fa-solid fa-rocket"></i>
            </div>
            <h1 class="page-title">Space Dashboard</h1>
            <p class="page-subtitle">Optimized Full-Width Layout</p>
        </div>

        <!-- Irrigation Tasks Card with Real-Time Calendar -->
        <div class="tasks-calendar-card">
            <div class="tasks-calendar-header">
                <div class="tasks-calendar-icon" id="tasks-toggle-card">
                    <i class="fa-solid fa-calendar-days"></i>
                </div>
                <div class="tasks-calendar-info">
                    <h3>Irrigation Tasks Calendar</h3>
                    <div class="tasks-calendar-datetime">
                        <i class="fa-solid fa-clock"></i>
                        <span id="tasks-current-time">--:--:--</span>
                        <span class="datetime-separator">•</span>
                        <span id="tasks-current-date">--- --, ----</span>
                    </div>
                </div>
                <div class="tasks-calendar-actions">
                    <button class="tasks-action-btn" id="add-schedule-btn" title="Add New Schedule">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                    <button class="tasks-action-btn" id="update-schedule-btn" title="Update Schedules">
                        <i class="fa-solid fa-rotate"></i>
                    </button>
                </div>
            </div>
            <div class="tasks-calendar-stats">
                <div class="tasks-stat-item">
                    <i class="fa-solid fa-list-check"></i>
                    <span><strong id="tasks-count">0</strong> Tasks Scheduled</span>
                </div>
                <div class="tasks-stat-item">
                    <i class="fa-solid fa-rotate"></i>
                    <span>Auto-refresh: <strong id="refresh-countdown">30s</strong></span>
                </div>
            </div>
        </div>
        
        <!-- Real-Time Sensor Data Grid -->
        <div class="sensor-grid">
            <div class="sensor-card">
                <div class="sensor-icon soil">
                    <i class="fa-solid fa-seedling"></i>
                </div>
                <div class="sensor-content">
                    <div class="sensor-label">Soil Moisture</div>
                    <div class="sensor-value" id="soil-moisture">--</div>
                    <div class="sensor-unit">%</div>
                    <div class="sensor-status" id="soil-status">Loading...</div>
                </div>
            </div>

            <div class="sensor-card">
                <div class="sensor-icon temp">
                    <i class="fa-solid fa-temperature-half"></i>
                </div>
                <div class="sensor-content">
                    <div class="sensor-label">Temperature</div>
                    <div class="sensor-value" id="temperature">--</div>
                    <div class="sensor-unit">°C</div>
                    <div class="sensor-status" id="temp-status">Loading...</div>
                </div>
            </div>

            <div class="sensor-card">
                <div class="sensor-icon humidity">
                    <i class="fa-solid fa-droplet"></i>
                </div>
                <div class="sensor-content">
                    <div class="sensor-label">Humidity</div>
                    <div class="sensor-value" id="humidity">--</div>
                    <div class="sensor-unit">%</div>
                    <div class="sensor-status" id="humidity-status">Loading...</div>
                </div>
            </div>

            <div class="sensor-card">
                <div class="sensor-icon battery">
                    <i class="fa-solid fa-battery-three-quarters"></i>
                </div>
                <div class="sensor-content">
                    <div class="sensor-label">Battery Level</div>
                    <div class="sensor-value" id="battery">--</div>
                    <div class="sensor-unit">%</div>
                    <div class="sensor-status" id="battery-status">Loading...</div>
                </div>
            </div>

            <div class="sensor-card">
                <div class="sensor-icon solar">
                    <i class="fa-solid fa-solar-panel"></i>
                </div>
                <div class="sensor-content">
                    <div class="sensor-label">Solar Status</div>
                    <div class="sensor-value" id="solar-status">--</div>
                    <div class="sensor-unit"></div>
                    <div class="sensor-status" id="solar-text">Loading...</div>
                </div>
            </div>

            <div class="sensor-card">
                <div class="sensor-icon water">
                    <i class="fa-solid fa-faucet"></i>
                </div>
                <div class="sensor-content">
                    <div class="sensor-label">Water Flow</div>
                    <div class="sensor-value" id="flow-rate">--</div>
                    <div class="sensor-unit">L/min</div>
                    <div class="sensor-status" id="flow-status">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-section-space">
            <div class="control-card">
                <div class="card-header">
                    <h3><i class="fa-solid fa-valve"></i> Irrigation Control</h3>
                    <span class="valve-badge" id="valve-badge">OFF</span>
                </div>
                <div class="card-body">
                    <div class="control-buttons">
                        <button class="btn btn-success" id="start-irrigation">
                            <i class="fa-solid fa-play"></i> Start Irrigation
                        </button>
                        <button class="btn btn-danger" id="stop-irrigation">
                            <i class="fa-solid fa-stop"></i> Stop Irrigation
                        </button>
                        <button class="btn btn-warning" id="emergency-stop">
                            <i class="fa-solid fa-circle-exclamation"></i> Emergency Stop
                        </button>
                    </div>
                    <div class="irrigation-info">
                        <div class="info-item">
                            <span class="info-label">Duration:</span>
                            <span class="info-value" id="irrigation-duration">--</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Water Used:</span>
                            <span class="info-value" id="water-used">--</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Last Irrigation:</span>
                            <span class="info-value" id="last-irrigation">--</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="control-card">
                <div class="card-header">
                    <h3><i class="fa-solid fa-brain"></i> AI Recommendation</h3>
                    <label class="toggle-switch">
                        <input type="checkbox" id="auto-mode">
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">Auto Mode</span>
                    </label>
                </div>
                <div class="card-body">
                    <div class="ai-recommendation" id="ai-recommendation">
                        <div class="recommendation-loading">
                            <i class="fa-solid fa-spinner fa-spin"></i> Loading AI recommendation...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Zones Display -->
        <div class="zones-section" id="zones-section">
            <h2><i class="fa-solid fa-layer-group"></i> Irrigation Zones</h2>
            <div class="zones-grid" id="zones-grid">
                <!-- Zones will be dynamically loaded -->
            </div>
        </div>

        <!-- Statistics Overview Cards -->
        <div class="stats-overview">
            <div class="stat-card temp-stat">
                <div class="stat-icon">
                    <i class="fa-solid fa-temperature-half"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Temperature Avg</div>
                    <div class="stat-value" id="temp-avg">--</div>
                    <div class="stat-unit">°C</div>
                    <div class="stat-trend" id="temp-trend">--</div>
                </div>
            </div>
            
            <div class="stat-card humidity-stat">
                <div class="stat-icon">
                    <i class="fa-solid fa-droplet"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Humidity Avg</div>
                    <div class="stat-value" id="humidity-avg">--</div>
                    <div class="stat-unit">%</div>
                    <div class="stat-trend" id="humidity-trend">--</div>
                </div>
            </div>
            
            <div class="stat-card irrigation-stat">
                <div class="stat-icon">
                    <i class="fa-solid fa-faucet"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Irrigation Time</div>
                    <div class="stat-value" id="irrigation-total">--</div>
                    <div class="stat-unit">min</div>
                    <div class="stat-trend" id="irrigation-trend">--</div>
                </div>
            </div>
            
            <div class="stat-card moisture-stat">
                <div class="stat-icon">
                    <i class="fa-solid fa-seedling"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Soil Moisture Avg</div>
                    <div class="stat-value" id="moisture-avg">--</div>
                    <div class="stat-unit">%</div>
                    <div class="stat-trend" id="moisture-trend">--</div>
                </div>
            </div>
        </div>

        <!-- Main Chart: Combined Temperature, Humidity & Irrigation -->
        <div class="chart-card chart-main">
            <div class="card-header">
                <h3><i class="fa-solid fa-chart-mixed"></i> Real-Time Environmental Data (24h)</h3>
                <div class="chart-controls">
                    <button class="chart-btn active" data-range="24h">24h</button>
                    <button class="chart-btn" data-range="7d">7d</button>
                    <button class="chart-btn" data-range="30d">30d</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="combined-chart"></canvas>
            </div>
        </div>

        <!-- Secondary Charts Grid -->
        <div class="charts-grid-space">
            <div class="chart-card">
                <div class="card-header">
                    <h3><i class="fa-solid fa-chart-line"></i> Temperature Trends</h3>
                </div>
                <div class="card-body">
                    <canvas id="temp-chart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="card-header">
                    <h3><i class="fa-solid fa-chart-area"></i> Humidity & Irrigation</h3>
                </div>
                <div class="card-body">
                    <canvas id="humidity-irrigation-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- System Status & Activity -->
        <div class="status-activity-grid">
            <div class="status-card">
                <div class="card-header">
                    <h3><i class="fa-solid fa-shield-halved"></i> Safety Status</h3>
                </div>
                <div class="card-body">
                    <div class="status-grid" id="safety-status-grid">
                        <div class="status-item">
                            <i class="fa-solid fa-spinner fa-spin"></i>
                            <span>Loading Safety Status...</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="status-card">
                <div class="card-header">
                    <h3><i class="fa-solid fa-clock-rotate-left"></i> Recent Activity</h3>
                </div>
                <div class="card-body">
                    <div class="activity-list" id="activity-list">
                        <!-- Activity items will be loaded here -->
                    </div>
                </div>
            </div>

            <div class="status-card">
                <div class="card-header">
                    <h3><i class="fa-solid fa-calendar-days"></i> Irrigation Schedule</h3>
                </div>
                <div class="card-body">
                    <div class="schedule-table-container">
                        <table class="schedule-table">
                            <thead>
                                <tr>
                                    <th>Start day</th>
                                    <th>Start time</th>
                                    <th>Duration</th>
                                    <th>Volume</th>
                                    <th>Progress</th>
                                </tr>
                            </thead>
                            <tbody id="schedule-table-body">
                                <tr>
                                    <td colspan="5" class="schedule-loading">
                                        <i class="fa-solid fa-spinner fa-spin"></i>
                                        <span>Loading schedule...</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Schedule Modal -->
    <div class="schedule-modal" id="schedule-modal">
        <div class="schedule-modal-overlay" id="schedule-modal-overlay"></div>
        <div class="schedule-modal-content">
            <div class="schedule-modal-header">
                <h3><i class="fa-solid fa-calendar-plus"></i> Add New Irrigation Schedule</h3>
                <button class="schedule-modal-close" id="schedule-modal-close">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="schedule-modal-body">
                <div class="schedule-form-group">
                    <label>Schedule Name</label>
                    <input type="text" id="schedule-name" placeholder="e.g., Morning Irrigation" class="schedule-input">
                </div>
                
                <div class="schedule-form-row">
                    <div class="schedule-form-group">
                        <label>Start Time</label>
                        <input type="time" id="schedule-start-time" class="schedule-input">
                    </div>
                    <div class="schedule-form-group">
                        <label>Duration (minutes)</label>
                        <input type="number" id="schedule-duration" placeholder="30" min="1" max="120" class="schedule-input">
                    </div>
                </div>
                
                <div class="schedule-form-group">
                    <label>Days of Week</label>
                    <div class="schedule-days">
                        <button class="day-btn" data-day="Monday">Mon</button>
                        <button class="day-btn" data-day="Tuesday">Tue</button>
                        <button class="day-btn" data-day="Wednesday">Wed</button>
                        <button class="day-btn" data-day="Thursday">Thu</button>
                        <button class="day-btn" data-day="Friday">Fri</button>
                        <button class="day-btn" data-day="Saturday">Sat</button>
                        <button class="day-btn" data-day="Sunday">Sun</button>
                    </div>
                </div>
                
                <div class="schedule-form-group">
                    <label>Soil Moisture Threshold (%)</label>
                    <input type="number" id="schedule-threshold" placeholder="30" min="0" max="100" class="schedule-input">
                </div>
            </div>
            <div class="schedule-modal-footer">
                <button class="schedule-btn schedule-btn-cancel" id="schedule-cancel-btn">Cancel</button>
                <button class="schedule-btn schedule-btn-save" id="schedule-save-btn">
                    <i class="fa-solid fa-check"></i> Save Schedule
                </button>
            </div>
        </div>
    </div>

    <!-- Right Irrigation Tasks Sidebar -->
    <aside class="irrigation-tasks-sidebar" id="irrigation-tasks-sidebar">
        <div class="tasks-sidebar-header">
            <div class="tasks-header-title">
                <i class="fa-solid fa-calendar-days"></i>
                <h3>Irrigation Tasks</h3>
            </div>
            <button class="tasks-close-btn" id="tasks-close-btn" aria-label="Close Tasks">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        
        <div class="tasks-sidebar-subtitle">
            <i class="fa-solid fa-clock"></i>
            <span>Realtime - last 7 days</span>
        </div>
        
        <div class="tasks-table-container">
            <table class="tasks-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Duration</th>
                        <th>Volume</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="tasks-table-body">
                    <tr>
                        <td colspan="6" class="tasks-loading">
                            <i class="fa-solid fa-spinner fa-spin"></i>
                            <span>Loading tasks...</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </aside>
    </div>

    <!-- Clean Black Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-description">
                <h3>Elevate One</h3>
                <p>Experience efficient and sustainable farming with Elevate One. Our cutting-edge irrigation technology optimizes water usage, reduces waste, and boosts crop yields.</p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2026 Elevate One. All rights reserved.</p>
        </div>
    </footer>

    <!-- Notification Panel -->
    <div class="notification-panel" id="notificationPanel">
        <div class="notification-header">
            <h3><i class="fa-solid fa-bell"></i> Notifications</h3>
            <button class="close-panel" onclick="closeNotificationPanel()">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        <div class="notification-list" id="notificationList">
            <!-- Notifications will be loaded here -->
        </div>
    </div>

    <!-- Modals -->
    <div id="custom-modal" class="custom-modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <i class="fa-solid fa-exclamation-triangle modal-icon"></i>
                <h3 class="modal-title">Return to Setup</h3>
            </div>
            <div class="modal-body">
                <p>This will reset your current setup configuration. Are you sure you want to continue?</p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" id="modal-cancel">
                    <i class="fa-solid fa-times"></i>
                    <span>Cancel</span>
                </button>
                <button class="modal-btn modal-btn-confirm" id="modal-confirm">
                    <i class="fa-solid fa-check"></i>
                    <span>Confirm</span>
                </button>
            </div>
        </div>
    </div>

    <div id="updateModal" class="custom-modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <i class="fa-solid fa-rotate modal-icon"></i>
                <h3 class="modal-title">System Update</h3>
            </div>
            <div class="modal-body" id="updateModalBody">
                <p>Checking for updates...</p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" id="updateModalCancel">
                    <i class="fa-solid fa-times"></i>
                    <span>Close</span>
                </button>
                <button class="modal-btn modal-btn-confirm" id="installUpdateBtn" style="display: none;">
                    <i class="fa-solid fa-download"></i>
                    <span>Install Update</span>
                </button>
            </div>
        </div>
    </div>

    <div id="rebootModal" class="custom-modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <i class="fa-solid fa-power-off modal-icon"></i>
                <h3 class="modal-title">Reboot System</h3>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to reboot the ElivateOne system?</p>
                <p style="color: #FFC107; margin-top: 1rem;">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                    This will temporarily interrupt irrigation operations.
                </p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" id="rebootModalCancel">
                    <i class="fa-solid fa-times"></i>
                    <span>Cancel</span>
                </button>
                <button class="modal-btn modal-btn-confirm" id="confirmRebootBtn">
                    <i class="fa-solid fa-power-off"></i>
                    <span>Reboot Now</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Irrigation Tasks Calendar Modal -->
    <div id="tasksCalendarModal" class="custom-modal" style="display: none;">
        <div class="modal-overlay" onclick="closeTasksCalendar()"></div>
        <div class="modal-content calendar-modal-content">
            <div class="modal-header">
                <i class="fa-solid fa-calendar-days modal-icon"></i>
                <h3 class="modal-title">Irrigation Tasks Calendar</h3>
                <button class="modal-close-btn" onclick="closeTasksCalendar()">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="modal-body calendar-modal-body">
                <!-- Calendar View -->
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="calendar-nav-btn" onclick="previousMonth()">
                            <i class="fa-solid fa-chevron-left"></i>
                        </button>
                        <h3 id="calendar-month-year">January 2026</h3>
                        <button class="calendar-nav-btn" onclick="nextMonth()">
                            <i class="fa-solid fa-chevron-right"></i>
                        </button>
                    </div>
                    <div class="calendar-grid">
                        <div class="calendar-day-header">Sun</div>
                        <div class="calendar-day-header">Mon</div>
                        <div class="calendar-day-header">Tue</div>
                        <div class="calendar-day-header">Wed</div>
                        <div class="calendar-day-header">Thu</div>
                        <div class="calendar-day-header">Fri</div>
                        <div class="calendar-day-header">Sat</div>
                        <!-- Calendar days will be generated by JavaScript -->
                        <div id="calendar-days"></div>
                    </div>
                </div>
                
                <!-- Task Form -->
                <div class="task-form-container">
                    <h4><i class="fa-solid fa-plus-circle"></i> Add/Edit Irrigation Task</h4>
                    <form id="task-form" onsubmit="saveTask(event)">
                        <div class="form-group">
                            <label>Task Name</label>
                            <input type="text" id="task-name" placeholder="e.g., Water Zone 1" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Date</label>
                                <input type="date" id="task-date" required>
                            </div>
                            <div class="form-group">
                                <label>Time</label>
                                <input type="time" id="task-time" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Zone</label>
                            <select id="task-zone" required>
                                <option value="">Select Zone</option>
                                <option value="zone1">Zone 1</option>
                                <option value="zone2">Zone 2</option>
                                <option value="zone3">Zone 3</option>
                                <option value="zone4">Zone 4</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Duration (minutes)</label>
                            <input type="number" id="task-duration" min="1" max="120" placeholder="30" required>
                        </div>
                        <div class="form-group">
                            <label>Repeat</label>
                            <select id="task-repeat">
                                <option value="none">No Repeat</option>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn-secondary" onclick="clearTaskForm()">
                                <i class="fa-solid fa-eraser"></i> Clear
                            </button>
                            <button type="submit" class="btn-primary">
                                <i class="fa-solid fa-save"></i> Save Task
                            </button>
                        </div>
                    </form>
                    
                    <!-- Tasks List -->
                    <div class="tasks-list-container">
                        <h4><i class="fa-solid fa-list"></i> Scheduled Tasks</h4>
                        <div id="tasks-list" class="tasks-list">
                            <!-- Tasks will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/dashboard.js?v=4.0"></script>
    <script src="js/space.js"></script>
    <script src="js/language.js?v=1.0"></script>
    
    <script>
        // Show loader on page load
        window.addEventListener('load', function() {
            const loader = document.getElementById('globalLoader');
            if (loader) {
                setTimeout(() => {
                    loader.classList.add('hidden');
                }, 500);
            }
        });
        
        // Calendar functionality
        let currentDate = new Date();
        let selectedDate = null;
        let tasks = [];
        
        // Open calendar modal
        function openTasksCalendar() {
            document.getElementById('tasksCalendarModal').style.display = 'flex';
            renderCalendar();
            loadTasks();
        }
        
        // Close calendar modal
        function closeTasksCalendar() {
            document.getElementById('tasksCalendarModal').style.display = 'none';
        }
        
        // Render calendar
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('calendar-month-year').textContent = 
                new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const calendarDays = document.getElementById('calendar-days');
            calendarDays.innerHTML = '';
            
            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day empty';
                calendarDays.appendChild(emptyCell);
            }
            
            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                dayCell.textContent = day;
                
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const tasksOnDay = tasks.filter(t => t.date === dateStr);
                
                if (tasksOnDay.length > 0) {
                    dayCell.classList.add('has-tasks');
                    const badge = document.createElement('span');
                    badge.className = 'task-badge';
                    badge.textContent = tasksOnDay.length;
                    dayCell.appendChild(badge);
                }
                
                const today = new Date();
                if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                    dayCell.classList.add('today');
                }
                
                dayCell.onclick = () => selectDate(dateStr, dayCell);
                calendarDays.appendChild(dayCell);
            }
        }
        
        function selectDate(dateStr, element) {
            document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
            element.classList.add('selected');
            selectedDate = dateStr;
            document.getElementById('task-date').value = dateStr;
        }
        
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }
        
        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }
        
        function saveTask(event) {
            event.preventDefault();
            
            const task = {
                id: Date.now(),
                name: document.getElementById('task-name').value,
                date: document.getElementById('task-date').value,
                time: document.getElementById('task-time').value,
                zone: document.getElementById('task-zone').value,
                duration: document.getElementById('task-duration').value,
                repeat: document.getElementById('task-repeat').value
            };
            
            tasks.push(task);
            localStorage.setItem('irrigation_tasks', JSON.stringify(tasks));
            
            clearTaskForm();
            renderCalendar();
            loadTasks();
            
            showNotification('Task saved successfully!', 'success');
        }
        
        function clearTaskForm() {
            document.getElementById('task-form').reset();
        }
        
        async function loadTasks() {
            // Load tasks from localStorage
            const stored = localStorage.getItem('irrigation_tasks');
            if (stored) {
                tasks = JSON.parse(stored);
            }
            
            // Also load schedules from backend/setup
            try {
                const response = await fetch('/api/schedules');
                if (response.ok) {
                    const schedules = await response.json();
                    
                    // Convert schedules to tasks format for calendar display
                    schedules.forEach(schedule => {
                        if (schedule.enabled) {
                            // Create task entries for the next 30 days based on days_of_week
                            const daysOfWeek = schedule.days_of_week ? schedule.days_of_week.split(',') : [];
                            const today = new Date();
                            
                            for (let i = 0; i < 30; i++) {
                                const date = new Date(today);
                                date.setDate(today.getDate() + i);
                                const dayName = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][date.getDay()];
                                
                                if (daysOfWeek.includes(dayName)) {
                                    const dateStr = date.toISOString().split('T')[0];
                                    const existingTask = tasks.find(t => 
                                        t.date === dateStr && 
                                        t.time === schedule.start_time && 
                                        t.name === schedule.name
                                    );
                                    
                                    if (!existingTask) {
                                        tasks.push({
                                            id: `schedule-${schedule.id}-${dateStr}`,
                                            name: schedule.name,
                                            date: dateStr,
                                            time: schedule.start_time,
                                            zone: 'Auto',
                                            duration: Math.floor(schedule.duration / 60),
                                            repeat: 'weekly',
                                            fromSchedule: true
                                        });
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.log('Could not load schedules from backend:', error);
            }
            
            const tasksList = document.getElementById('tasks-list');
            tasksList.innerHTML = '';
            
            if (tasks.length === 0) {
                tasksList.innerHTML = '<p class="no-tasks">No tasks scheduled. Create a task or check your irrigation schedules.</p>';
                return;
            }
            
            tasks.sort((a, b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time));
            
            // Show only upcoming tasks (next 30 days)
            const today = new Date();
            const futureDate = new Date();
            futureDate.setDate(today.getDate() + 30);
            
            const upcomingTasks = tasks.filter(task => {
                const taskDate = new Date(task.date);
                return taskDate >= today && taskDate <= futureDate;
            });
            
            if (upcomingTasks.length === 0) {
                tasksList.innerHTML = '<p class="no-tasks">No upcoming tasks in the next 30 days</p>';
                return;
            }
            
            upcomingTasks.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = 'task-item';
                const isFromSchedule = task.fromSchedule ? '<span class="schedule-badge">Auto</span>' : '';
                taskItem.innerHTML = `
                    <div class="task-info">
                        <div class="task-name"><i class="fa-solid fa-droplet"></i> ${task.name} ${isFromSchedule}</div>
                        <div class="task-details">
                            <span><i class="fa-solid fa-calendar"></i> ${task.date}</span>
                            <span><i class="fa-solid fa-clock"></i> ${task.time}</span>
                            <span><i class="fa-solid fa-layer-group"></i> ${task.zone}</span>
                            <span><i class="fa-solid fa-hourglass"></i> ${task.duration}min</span>
                        </div>
                    </div>
                    ${!task.fromSchedule ? `<button class="task-delete-btn" onclick="deleteTask(${task.id})">
                        <i class="fa-solid fa-trash"></i>
                    </button>` : ''}
                `;
                tasksList.appendChild(taskItem);
            });
        }
        
        function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                tasks = tasks.filter(t => t.id !== taskId);
                localStorage.setItem('irrigation_tasks', JSON.stringify(tasks));
                renderCalendar();
                loadTasks();
                showNotification('Task deleted successfully!', 'success');
            }
        }
        
        // Bind calendar icon click
        document.getElementById('tasks-toggle-card')?.addEventListener('click', openTasksCalendar);
        document.getElementById('add-schedule-btn')?.addEventListener('click', openTasksCalendar);
        
        // Drag and Drop Functionality
        let dragEnabled = false;
        let draggedElement = null;
        
        function toggleDragMode() {
            dragEnabled = !dragEnabled;
            const toggleBtn = document.getElementById('dragToggleBtn');
            const draggableCards = document.querySelectorAll('.sensor-card, .control-card, .chart-card, .status-card, .tasks-calendar-card');
            
            if (dragEnabled) {
                toggleBtn.classList.add('active');
                toggleBtn.style.background = 'rgba(0, 0, 0, 0.3)';
                showNotification('Drag & Drop Mode Enabled - Rearrange your dashboard!', 'info');
                
                draggableCards.forEach(card => {
                    card.setAttribute('draggable', 'true');
                    card.classList.add('draggable-active');
                    
                    card.addEventListener('dragstart', handleDragStart);
                    card.addEventListener('dragend', handleDragEnd);
                    card.addEventListener('dragover', handleDragOver);
                    card.addEventListener('drop', handleDrop);
                    card.addEventListener('dragenter', handleDragEnter);
                    card.addEventListener('dragleave', handleDragLeave);
                });
            } else {
                toggleBtn.classList.remove('active');
                toggleBtn.style.background = '';
                showNotification('Drag & Drop Mode Disabled', 'info');
                
                draggableCards.forEach(card => {
                    card.setAttribute('draggable', 'false');
                    card.classList.remove('draggable-active', 'drag-over');
                    
                    card.removeEventListener('dragstart', handleDragStart);
                    card.removeEventListener('dragend', handleDragEnd);
                    card.removeEventListener('dragover', handleDragOver);
                    card.removeEventListener('drop', handleDrop);
                    card.removeEventListener('dragenter', handleDragEnter);
                    card.removeEventListener('dragleave', handleDragLeave);
                });
            }
        }
        
        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }
        
        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(card => {
                card.classList.remove('drag-over');
            });
        }
        
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        function handleDragEnter(e) {
            if (this !== draggedElement) {
                this.classList.add('drag-over');
            }
        }
        
        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }
        
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedElement !== this) {
                const parent = this.parentNode;
                const draggedIndex = Array.from(parent.children).indexOf(draggedElement);
                const targetIndex = Array.from(parent.children).indexOf(this);
                
                if (draggedIndex < targetIndex) {
                    parent.insertBefore(draggedElement, this.nextSibling);
                } else {
                    parent.insertBefore(draggedElement, this);
                }
                
                saveDashboardLayout();
            }
            
            this.classList.remove('drag-over');
            return false;
        }
        
        function saveDashboardLayout() {
            const layout = {};
            
            // Save sensor grid layout
            const sensorGrid = document.querySelector('.sensor-grid');
            if (sensorGrid) {
                layout.sensorGrid = Array.from(sensorGrid.children).map(card => card.className);
            }
            
            // Save control section layout
            const controlSection = document.querySelector('.control-section-space');
            if (controlSection) {
                layout.controlSection = Array.from(controlSection.children).map(card => card.className);
            }
            
            // Save charts grid layout
            const chartsGrid = document.querySelector('.charts-grid-space');
            if (chartsGrid) {
                layout.chartsGrid = Array.from(chartsGrid.children).map(card => card.className);
            }
            
            // Save status activity grid layout
            const statusGrid = document.querySelector('.status-activity-grid');
            if (statusGrid) {
                layout.statusGrid = Array.from(statusGrid.children).map(card => card.className);
            }
            
            localStorage.setItem('dashboard_layout', JSON.stringify(layout));
            showNotification('Dashboard layout saved!', 'success');
        }
        
        function loadDashboardLayout() {
            const savedLayout = localStorage.getItem('dashboard_layout');
            if (!savedLayout) return;
            
            try {
                const layout = JSON.parse(savedLayout);
                // Layout restoration logic can be added here if needed
            } catch (e) {
                console.error('Error loading dashboard layout:', e);
            }
        }
        
        // Bind drag toggle button
        document.getElementById('dragToggleBtn')?.addEventListener('click', toggleDragMode);
        
        // Load saved layout on page load
        loadDashboardLayout();
    </script>
</body>
</html>
