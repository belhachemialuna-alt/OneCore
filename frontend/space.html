<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Dashboard - ElivateOne</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico?v=1.0">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.0">
    <link rel="apple-touch-icon" href="/favicon.ico?v=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mulish:ital,wght@0,200..1000;1,200..1000&family=News+Cycle:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/dashboard.css?v=5.0">
    <link rel="stylesheet" href="css/space.css?v=2.0">
    <link rel="stylesheet" href="css/loader.css">
    <link rel="stylesheet" href="css/system-performance.css">
    <link rel="stylesheet" href="css/schedule-modal.css">
    <link rel="stylesheet" href="css/calendar-modal.css">
    <link rel="stylesheet" href="css/space.css?v=5.0">
    <link rel="stylesheet" href="css/enhanced-notifications.css?v=1.0">
    <link rel="stylesheet" href="css/mobile-header-enhancement.css?v=2.0">
    <link rel="stylesheet" href="css/mobile-header-fix.css?v=2.0">
    <link rel="stylesheet" href="css/pdf-export-styles.css?v=1.0">
    <link rel="stylesheet" href="css/professional-chat.css">
    <link rel="stylesheet" href="css/language-switch.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Global Loader -->
    <div class="global-loader" id="globalLoader">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <div class="loader-text">Loading...</div>
        </div>
    </div>

    <script>
        // Check if setup is complete, redirect to setup if not
        // Only check once on page load, not during status updates
        (function() {
            if (!localStorage.getItem('elivate_setup_complete')) {
                // Small delay to prevent redirect during status updates
                setTimeout(function() {
                    if (!localStorage.getItem('elivate_setup_complete')) {
                        window.location.href = 'setup.html';
                    }
                }, 100);
            }
        })();
    </script>

    <!-- Red Header Bar -->
    <header class="top-header">
        <div class="header-container">
            <button class="mobile-menu-btn" id="mobile-menu-btn" aria-label="Menu">
                <i class="fa-solid fa-ellipsis-vertical"></i>
            </button>
            <div class="header-left">
                <div class="logo logo-setup-container">
                    <a href="space.html">
                        <img src="TIONESETUP.png" alt="TiOne Logo" class="logo-setup-image">
                    </a>
                </div>
            </div>
            <div class="header-center">
                <div class="header-datetime header-clock-large" id="header-datetime">
                    <i class="fa-solid fa-clock"></i>
                    <span id="header-time">--:--</span>
                    <span class="datetime-separator">•</span>
                    <span id="header-date">--- --, ----</span>
                </div>
            </div>
            <div class="header-right">
                <button class="header-icon-btn" id="alertBtn" title="Alerts & Warnings">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                    <span class="alert-counter" id="alertCounter">0</span>
                </button>
                <button class="header-icon-btn" id="notificationBtn" title="System Notifications">
                    <i class="fa-solid fa-bell"></i>
                    <span class="notification-badge" id="notificationBadge">0</span>
                </button>
                <button class="header-icon-btn" id="updateBtnMain" title="Check for system updates">
                    <i class="fa-solid fa-rotate"></i>
                    <span class="update-indicator" id="updateIndicator"></span>
                </button>
                <button class="header-icon-btn drag-toggle-btn" id="dragToggleBtn" title="Enable/Disable Drag & Drop">
                    <i class="fa-solid fa-grip-vertical"></i>
                </button>
                <a href="analytics.html" class="header-icon-btn" title="View Analytics Dashboard">
                    <i class="fa-solid fa-chart-line"></i>
                </a>
                <a href="emergency.html" class="header-icon-btn" title="Emergency Controls">
                    <i class="fa-solid fa-fire-extinguisher"></i>
                </a>
                <a href="hardware.html" class="header-icon-btn" title="Hardware Schema">
                    <img src="icons/HARDWARE.png" alt="Hardware" style="width: 20px; height: 20px; object-fit: contain;">
                </a>
                <a href="controls.html" class="header-icon-btn" title="User & System Controls">
                    <i class="fa-solid fa-sliders"></i>
                </a>
                <a href="../PI_simulation/device_registration.html" class="header-icon-btn" title="PI Data Simulation">
                    <i class="fa-solid fa-microchip"></i>
                </a>
                <a href="ai.html" class="header-icon-btn" title="AI Model Testing">
                    <img src="icons/AI.png" alt="AI" style="width: 20px; height: 20px; object-fit: contain;">
                </a>
                <a href="support.html" class="header-icon-btn" title="Support">
                    <i class="fa-solid fa-circle-question"></i>
                </a>
                <a href="faq.html" class="header-icon-btn" title="FAQ">
                    <i class="fa-solid fa-book"></i>
                </a>
                <button class="header-icon-btn" id="languageBtn" title="Switch Language">
                    <img src="icons/language.png" alt="Language" style="width: 20px; height: 20px; object-fit: contain;">
                </button>
                <a href="#" class="header-icon-btn" id="setup-link" aria-label="Return to Setup" title="Return to Setup">
                    <img src="icons/SETUP.png" alt="Setup" style="width: 20px; height: 20px; object-fit: contain;">
                </a>
                <button class="header-icon-btn reboot-btn" id="rebootBtn" title="Reboot System">
                    <i class="fa-solid fa-power-off"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Mobile Page Title Bar -->
    <div class="mobile-page-title space-page show" id="mobilePageTitle">
        <div class="mobile-page-title-content">
            <div class="mobile-page-title-icon">
                <i class="fa-solid fa-rocket"></i>
            </div>
            <div class="mobile-page-title-text">Space Dashboard</div>
        </div>
    </div>

    <!-- Secondary Navigation Bar -->
    <nav class="secondary-nav">
        <div class="nav-container">
            <div class="nav-title">
                <i class="fa-solid fa-rocket"></i>
                <span>Space Dashboard</span>
            </div>
            <div class="nav-search">
                <div class="search-container">
                    <input type="text" id="global-search" placeholder="Search options, controls, settings..." class="search-input">
                    <button type="button" id="search-btn" class="search-btn" title="Search">
                        <i class="fa-solid fa-search"></i>
                    </button>
                </div>
                <div class="search-results" id="search-results" style="display: none;">
                    <div class="search-loading" id="search-loading" style="display: none;">
                        <i class="fa-solid fa-spinner fa-spin"></i>
                        <span>Searching...</span>
                    </div>
                    <div class="search-content" id="search-content"></div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Sidebar Menu -->
    <div class="mobile-sidebar" id="mobile-sidebar">
        <div class="sidebar-overlay" id="sidebar-overlay"></div>
        <div class="sidebar-content">
            <div class="sidebar-header">
                <button class="sidebar-close" id="sidebar-close" aria-label="Close Menu">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <nav class="sidebar-nav">
                <a href="index.html" class="sidebar-item" title="Dashboard">
                    <i class="fa-solid fa-gauge"></i>
                </a>
                <button class="sidebar-item" id="updateBtnMobile" title="Check for system updates">
                    <i class="fa-solid fa-rotate"></i>
                </button>
                <a href="space.html" class="sidebar-item active" title="Space Dashboard">
                    <i class="fa-solid fa-rocket"></i>
                </a>
                <a href="analytics.html" class="sidebar-item" title="Analytics">
                    <i class="fa-solid fa-chart-line"></i>
                </a>
                <a href="emergency.html" class="sidebar-item" title="Emergency Controls">
                    <i class="fa-solid fa-fire-extinguisher"></i>
                </a>
                <a href="hardware.html" class="sidebar-item" title="Hardware Schema">
                    <i class="fa-solid fa-cpu"></i>
                </a>
                <a href="controls.html" class="sidebar-item" title="User & System Controls">
                    <i class="fa-solid fa-sliders"></i>
                </a>
                <a href="PI_simulation.html" class="sidebar-item" title="Pi Simulation - IoT Data Exchange">
                    <i class="fa-solid fa-microchip"></i>
                </a>
                <a href="ai.html" class="sidebar-item" title="AI Model Testing">
                    <img src="icons/AI.png" alt="AI" style="width: 20px; height: 20px; object-fit: contain;">
                </a>
                <a href="support.html" class="sidebar-item" title="Support">
                    <i class="fa-solid fa-circle-question"></i>
                </a>
                <a href="faq.html" class="sidebar-item" title="FAQ">
                    <i class="fa-solid fa-book"></i>
                </a>
                <a href="#" class="sidebar-item" id="setup-link-mobile" title="Return to Setup">
                    <i class="fa-solid fa-gear"></i>
                </a>
                <button class="sidebar-item" id="rebootBtnMobile" title="Reboot System">
                    <i class="fa-solid fa-power-off"></i>
                </button>
            </nav>
        </div>
    </div>

    <!-- Main Content with Sidebar Layout -->
    <div class="space-layout-container">
        <!-- Irrigation Timer Sidebar -->
        <aside class="irrigation-sidebar-space">
            <div class="irrigation-header-space">
                <i class="fa-solid fa-droplet"></i>
                <h3>Irrigation Time</h3>
            </div>
            
            <div class="circular-progress-container-space">
                <svg class="circular-progress-space" viewBox="0 0 200 200">
                    <circle class="progress-bg-space" cx="100" cy="100" r="85"></circle>
                    <circle class="progress-bar-space" cx="100" cy="100" r="85" id="irrigation-progress-circle-space"></circle>
                </svg>
                <div class="progress-content-space">
                    <div class="progress-value-space" id="irrigation-minutes-space">0</div>
                    <div class="progress-label-space">Minutes</div>
                    <div class="progress-sublabel-space">Today</div>
                </div>
            </div>
            
            <div class="irrigation-divider-space"></div>
            
            <div class="irrigation-stats-space">
                <div class="stat-item-space">
                    <div class="stat-icon-space">
                        <i class="fa-solid fa-valve"></i>
                    </div>
                    <div class="stat-info-space">
                        <div class="stat-label-space">Valve Opens</div>
                        <div class="stat-value-space" id="valve-open-count-space">0</div>
                    </div>
                </div>
                
                <div class="stat-item-space">
                    <div class="stat-icon-space">
                        <i class="fa-solid fa-clock"></i>
                    </div>
                    <div class="stat-info-space">
                        <div class="stat-label-space">Avg Duration</div>
                        <div class="stat-value-space" id="avg-duration-space">0 min</div>
                    </div>
                </div>
                
                <div class="stat-item-space">
                    <div class="stat-icon-space">
                        <i class="fa-solid fa-water"></i>
                    </div>
                    <div class="stat-info-space">
                        <div class="stat-label-space">Water Used</div>
                        <div class="stat-value-space" id="water-used-today-space">0 L</div>
                    </div>
                </div>
            </div>
            
            <div class="irrigation-status-space" id="irrigation-status-space">
                <div class="status-indicator-space status-idle"></div>
                <span>Idle</span>
            </div>
        </aside>

        <div class="space-main-content">
        <!-- Page Title -->
        <div class="page-title-section">
            <div class="page-title-icon">
                <i class="fa-solid fa-rocket"></i>
            </div>
            <h1 class="page-title" data-i18n="nav-space">Space Dashboard</h1>
        </div>

        <!-- Irrigation Tasks Card with Real-Time Calendar -->
        <div class="tasks-calendar-card">
            <div class="tasks-calendar-header">
                <div class="tasks-calendar-icon" id="tasks-toggle-card">
                    <i class="fa-solid fa-calendar-days"></i>
                </div>
                <div class="tasks-calendar-info">
                    <h3 data-i18n="irrigation-tasks-calendar">Irrigation Tasks Calendar</h3>
                    <div class="tasks-calendar-datetime">
                        <i class="fa-solid fa-clock"></i>
                        <span id="tasks-current-time">--:--:--</span>
                        <span class="datetime-separator">•</span>
                        <span id="tasks-current-date">--- --, ----</span>
                    </div>
                </div>
                <div class="tasks-calendar-actions">
                    <button class="tasks-action-btn" id="irrigation-config-btn" title="Irrigation Configuration">
                        <i class="fa-solid fa-gear"></i>
                    </button>
                    <button class="tasks-action-btn" id="add-schedule-btn" title="Add New Schedule">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                    <button class="tasks-action-btn" id="update-schedule-btn" title="Update Schedules">
                        <i class="fa-solid fa-rotate"></i>
                    </button>
                    <button class="tasks-action-btn" id="export-pdf-btn" title="Export Schedules to PDF">
                        <i class="fa-solid fa-file-pdf"></i>
                    </button>
                </div>
            </div>
            <div class="tasks-calendar-stats">
                <div class="tasks-stat-item clickable" id="tasks-scheduled-toggle" title="Click to view all tasks">
                    <i class="fa-solid fa-list-check"></i>
                    <span><strong id="tasks-count">0</strong> <span data-i18n="tasks-scheduled">Tasks Scheduled</span></span>
                    <i class="fa-solid fa-chevron-down toggle-icon"></i>
                </div>
                <div class="tasks-stat-item">
                    <i class="fa-solid fa-rotate"></i>
                    <span><span data-i18n="auto-refresh">Auto-refresh</span>: <strong id="refresh-countdown">30s</strong></span>
                </div>
            </div>
            
            <!-- Tasks Preview List (collapsed by default) -->
            <div class="tasks-preview-list" id="tasks-preview-list" style="display: none;">
                <div class="tasks-preview-header">
                    <h4><i class="fa-solid fa-calendar-check"></i> Upcoming Irrigation Tasks</h4>
                </div>
                <div class="tasks-preview-items" id="tasks-preview-items">
                    <!-- Tasks will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- Weather and Control Cards Row -->
        <div class="weather-control-row">
            <!-- Irrigation Control Card -->
            <div class="control-card-main">
                <div class="card-header">
                    <h3><i class="fa-solid fa-valve"></i> Irrigation Control</h3>
                    <span class="valve-badge-main" id="valve-badge-main">OFF</span>
                </div>
                <div class="card-body">
                    <div class="control-buttons">
                        <button class="btn btn-black" id="start-irrigation-main">
                            <i class="fa-solid fa-play"></i> Start Irrigation
                        </button>
                        <button class="btn btn-black" id="stop-irrigation-main">
                            <i class="fa-solid fa-stop"></i> Stop Irrigation
                        </button>
                        <button class="btn btn-black" id="emergency-stop-main">
                            <i class="fa-solid fa-circle-exclamation"></i> Emergency Stop
                        </button>
                        <button class="btn btn-black" id="irrigation-chat-btn">
                            <i class="fa-solid fa-comments"></i> Ask Assistant
                        </button>
                    </div>
                    <div class="irrigation-info">
                        <div class="info-item">
                            <span class="info-label">Duration:</span>
                            <span class="info-value" id="irrigation-duration-main">--</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Water Used:</span>
                            <span class="info-value" id="water-used-main">--</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Last Irrigation:</span>
                            <span class="info-value" id="last-irrigation-main">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section Title: Sensor Data -->
        <div class="section-title">
            <h3><i class="fa-solid fa-chart-line"></i> Real-Time Sensor Data</h3>
        </div>

        <!-- Real-Time Sensor Data Grid -->
        <div class="sensor-grid">
            <div class="sensor-card">
                <div class="sensor-icon soil">
                    <i class="fa-solid fa-seedling"></i>
                </div>
                <div class="sensor-content">
                    <div class="sensor-label">Soil Moisture</div>
                    <div class="sensor-value" id="soil-moisture">--</div>
                    <div class="sensor-unit">%</div>
                    <div class="sensor-status" id="soil-status">Loading...</div>
                </div>
            </div>

            <div class="sensor-card">
                <div class="sensor-icon temp">
                    <i class="fa-solid fa-temperature-half"></i>
                </div>
                <div class="sensor-content">
                    <div class="sensor-label">Temperature</div>
                    <div class="sensor-value" id="temperature">--</div>
                    <div class="sensor-unit">°C</div>
                    <div class="sensor-status" id="temp-status">Loading...</div>
                </div>
            </div>

            <div class="sensor-card">
                <div class="sensor-icon humidity">
                    <i class="fa-solid fa-droplet"></i>
                </div>
                <div class="sensor-content">
                    <div class="sensor-label">Humidity</div>
                    <div class="sensor-value" id="humidity">--</div>
                    <div class="sensor-unit">%</div>
                    <div class="sensor-status" id="humidity-status">Loading...</div>
                </div>
            </div>

            <div class="sensor-card">
                <div class="sensor-icon battery">
                    <i class="fa-solid fa-battery-three-quarters"></i>
                </div>
                <div class="sensor-content">
                    <div class="sensor-label">Battery Level</div>
                    <div class="sensor-value" id="battery">--</div>
                    <div class="sensor-unit">%</div>
                    <div class="sensor-status" id="battery-status">Loading...</div>
                </div>
            </div>

            <div class="sensor-card">
                <div class="sensor-icon solar">
                    <i class="fa-solid fa-solar-panel"></i>
                </div>
                <div class="sensor-content">
                    <div class="sensor-label">Solar Status</div>
                    <div class="sensor-value" id="solar-status">--</div>
                    <div class="sensor-unit"></div>
                    <div class="sensor-status" id="solar-text">Loading...</div>
                </div>
            </div>

            <div class="sensor-card">
                <div class="sensor-icon water">
                    <i class="fa-solid fa-faucet"></i>
                </div>
                <div class="sensor-content">
                    <div class="sensor-label">Water Flow</div>
                    <div class="sensor-value" id="flow-rate">--</div>
                    <div class="sensor-unit">L/min</div>
                    <div class="sensor-status" id="flow-status">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Section Title: Irrigation Zones -->
        <div class="section-title">
            <h3><i class="fa-solid fa-layer-group"></i> Irrigation Zones</h3>
        </div>

        <!-- Zones Display -->
        <div class="zones-section" id="zones-section">
            <div class="zones-grid" id="zones-grid">
                <!-- Zones will be dynamically loaded -->
            </div>
        </div>

        <!-- Section Title: Statistics Overview -->
        <div class="section-title">
            <h3><i class="fa-solid fa-chart-bar"></i> Statistics Overview</h3>
        </div>

        <!-- Statistics Overview Cards -->
        <div class="stats-overview">
            <div class="stat-card temp-stat">
                <div class="stat-icon">
                    <i class="fa-solid fa-temperature-half"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Temperature Avg</div>
                    <div class="stat-value" id="temp-avg">--</div>
                    <div class="stat-unit">°C</div>
                    <div class="stat-trend" id="temp-trend">--</div>
                </div>
            </div>
            
            <div class="stat-card humidity-stat">
                <div class="stat-icon">
                    <i class="fa-solid fa-droplet"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Humidity Avg</div>
                    <div class="stat-value" id="humidity-avg">--</div>
                    <div class="stat-unit">%</div>
                    <div class="stat-trend" id="humidity-trend">--</div>
                </div>
            </div>
            
            <div class="stat-card irrigation-stat">
                <div class="stat-icon">
                    <i class="fa-solid fa-faucet"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Irrigation Time</div>
                    <div class="stat-value" id="irrigation-total">--</div>
                    <div class="stat-unit">min</div>
                    <div class="stat-trend" id="irrigation-trend">--</div>
                </div>
            </div>
            
            <div class="stat-card moisture-stat">
                <div class="stat-icon">
                    <i class="fa-solid fa-seedling"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Soil Moisture Avg</div>
                    <div class="stat-value" id="moisture-avg">--</div>
                    <div class="stat-unit">%</div>
                    <div class="stat-trend" id="moisture-trend">--</div>
                </div>
            </div>
        </div>

        <!-- Section Title: Analytics & Charts -->
        <div class="section-title">
            <h3><i class="fa-solid fa-chart-mixed"></i> Analytics & Charts</h3>
        </div>

        <!-- Main Chart: Combined Temperature, Humidity & Irrigation -->
        <div class="chart-card chart-main">
            <div class="card-header">
                <h3><i class="fa-solid fa-chart-mixed"></i> Real-Time Environmental Data (24h)</h3>
                <div class="chart-controls">
                    <button class="chart-btn active" data-range="24h">24h</button>
                    <button class="chart-btn" data-range="7d">7d</button>
                    <button class="chart-btn" data-range="30d">30d</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="combined-chart"></canvas>
            </div>
        </div>

        <!-- Secondary Charts Grid -->
        <div class="charts-grid-space">
            <div class="chart-card">
                <div class="card-header">
                    <h3><i class="fa-solid fa-chart-line"></i> Temperature Trends</h3>
                </div>
                <div class="card-body">
                    <canvas id="temp-chart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <div class="card-header">
                    <h3><i class="fa-solid fa-chart-area"></i> Humidity & Irrigation</h3>
                </div>
                <div class="card-body">
                    <canvas id="humidity-irrigation-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Section Title: System Status -->
        <div class="section-title">
            <h3><i class="fa-solid fa-shield-halved"></i> System Status & Activity</h3>
        </div>

        <!-- System Status & Activity -->
        <div class="status-activity-grid">
            <div class="status-card">
                <div class="card-header">
                    <h3><i class="fa-solid fa-shield-halved"></i> Safety Status</h3>
                </div>
                <div class="card-body">
                    <div class="status-grid" id="safety-status-grid">
                        <div class="status-item loading">
                            <i class="fa-solid fa-check-circle"></i>
                            <span>Final Stage Check</span>
                            <div class="loading-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="status-card">
                <div class="card-header">
                    <h3><i class="fa-solid fa-clock-rotate-left"></i> Recent Activity</h3>
                </div>
                <div class="card-body">
                    <div class="activity-list" id="activity-list">
                        <!-- Activity items will be loaded here -->
                    </div>
                </div>
            </div>

            <div class="status-card">
                <div class="card-header">
                    <h3><i class="fa-solid fa-calendar-days"></i> Irrigation Schedule</h3>
                </div>
                <div class="card-body">
                    <div class="schedule-table-container">
                        <table class="schedule-table">
                            <thead>
                                <tr>
                                    <th>Start day</th>
                                    <th>Start time</th>
                                    <th>Duration</th>
                                    <th>Volume</th>
                                    <th>Progress</th>
                                </tr>
                            </thead>
                            <tbody id="schedule-table-body">
                                <tr>
                                    <td colspan="5" class="schedule-loading">
                                        <i class="fa-solid fa-spinner fa-spin"></i>
                                        <span>Loading schedule...</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Schedule Modal -->
    <div class="schedule-modal" id="schedule-modal">
        <div class="schedule-modal-overlay" id="schedule-modal-overlay"></div>
        <div class="schedule-modal-content">
            <div class="schedule-modal-header">
                <h3><i class="fa-solid fa-calendar-plus"></i> Add New Irrigation Schedule</h3>
                <button class="schedule-modal-close" id="schedule-modal-close">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="schedule-modal-body">
                <div class="schedule-form-group">
                    <label>Schedule Name</label>
                    <input type="text" id="schedule-name" placeholder="e.g., Morning Irrigation" class="schedule-input">
                </div>
                
                <div class="schedule-form-row">
                    <div class="schedule-form-group">
                        <label>Start Time</label>
                        <input type="time" id="schedule-start-time" class="schedule-input">
                    </div>
                    <div class="schedule-form-group">
                        <label>Duration (minutes)</label>
                        <input type="number" id="schedule-duration" placeholder="30" min="1" max="120" class="schedule-input">
                    </div>
                </div>
                
                <div class="schedule-form-group">
                    <label>Days of Week</label>
                    <div class="schedule-days">
                        <button class="day-btn" data-day="Monday">Mon</button>
                        <button class="day-btn" data-day="Tuesday">Tue</button>
                        <button class="day-btn" data-day="Wednesday">Wed</button>
                        <button class="day-btn" data-day="Thursday">Thu</button>
                        <button class="day-btn" data-day="Friday">Fri</button>
                        <button class="day-btn" data-day="Saturday">Sat</button>
                        <button class="day-btn" data-day="Sunday">Sun</button>
                    </div>
                </div>
                
                <div class="schedule-form-group">
                    <label>Soil Moisture Threshold (%)</label>
                    <input type="number" id="schedule-threshold" placeholder="30" min="0" max="100" class="schedule-input">
                </div>
            </div>
            <div class="schedule-modal-footer">
                <button class="schedule-btn schedule-btn-cancel" id="schedule-cancel-btn">Cancel</button>
                <button class="schedule-btn schedule-btn-save" id="schedule-save-btn">
                    <i class="fa-solid fa-check"></i> Save Schedule
                </button>
            </div>
        </div>
    </div>

    <!-- Right Irrigation Tasks Sidebar -->
    <aside class="irrigation-tasks-sidebar" id="irrigation-tasks-sidebar">
        <div class="tasks-sidebar-header">
            <div class="tasks-header-title">
                <i class="fa-solid fa-calendar-days"></i>
                <h3>Irrigation Tasks</h3>
            </div>
            <button class="tasks-close-btn" id="tasks-close-btn" aria-label="Close Tasks">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        
        <div class="tasks-sidebar-subtitle">
            <i class="fa-solid fa-clock"></i>
            <span>Realtime - last 7 days</span>
        </div>
        
        <div class="tasks-table-container">
            <table class="tasks-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Duration</th>
                        <th>Volume</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="tasks-table-body">
                    <tr>
                        <td colspan="6" class="tasks-loading">
                            <i class="fa-solid fa-spinner fa-spin"></i>
                            <span>Loading tasks...</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </aside>
    </div>

    <!-- Footer - Enhanced with Social Icons and Legal Links -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-logo">
                <img src="logofooter.png" alt="TiOne Logo" class="footer-logo-img">
            </div>
            <div class="footer-text">
                <p>All content on this site. Copyright © 2024 TiOne Smart Irrigation System. All rights reserved, including those for text and data mining, AI training, and similar technologies. For all open access content, the relevant licensing terms apply.</p>
            </div>
            <div class="footer-links">
                <a href="index.html">Dashboard</a>
                <a href="space.html">Space</a>
                <a href="analytics.html">Analytics</a>
                <a href="controls.html">Controls</a>
                <a href="support.html">Support</a>
            </div>
            <div class="footer-social">
                <div class="social-title">Follow Us</div>
                <div class="social-icons">
                    <a href="#" class="social-link" title="Facebook">
                        <i class="fab fa-facebook-f"></i>
                    </a>
                    <a href="#" class="social-link" title="Twitter">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="#" class="social-link" title="LinkedIn">
                        <i class="fab fa-linkedin-in"></i>
                    </a>
                    <a href="#" class="social-link" title="Instagram">
                        <i class="fab fa-instagram"></i>
                    </a>
                    <a href="#" class="social-link" title="YouTube">
                        <i class="fab fa-youtube"></i>
                    </a>
                </div>
            </div>
            <div class="footer-legal">
                <div class="legal-title">Legal</div>
                <div class="legal-links">
                    <a href="#" class="legal-link">Privacy Policy</a>
                    <a href="#" class="legal-link">Terms of Service</a>
                    <a href="#" class="legal-link">Cookie Policy</a>
                    <a href="#" class="legal-link">GDPR Compliance</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Notification Panel -->
    <div class="notification-panel" id="notificationPanel">
        <div class="notification-header">
            <h3><i class="fa-solid fa-bell"></i> Notifications</h3>
            <button class="close-panel" onclick="closeNotificationPanel()">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        <div class="notification-list" id="notificationList">
            <!-- Notifications will be loaded here -->
        </div>
    </div>

    <!-- Modals -->
    <div id="custom-modal" class="custom-modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <i class="fa-solid fa-exclamation-triangle modal-icon"></i>
                <h3 class="modal-title">Return to Setup</h3>
            </div>
            <div class="modal-body">
                <p>This will reset your current setup configuration. Are you sure you want to continue?</p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" id="modal-cancel">
                    <i class="fa-solid fa-times"></i>
                    <span>Cancel</span>
                </button>
                <button class="modal-btn modal-btn-confirm" id="modal-confirm">
                    <i class="fa-solid fa-check"></i>
                    <span>Confirm</span>
                </button>
            </div>
        </div>
    </div>

    <div id="updateModal" class="custom-modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <i class="fa-solid fa-rotate modal-icon"></i>
                <h3 class="modal-title">System Update</h3>
            </div>
            <div class="modal-body" id="updateModalBody">
                <p>Checking for updates...</p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" id="updateModalCancel">
                    <i class="fa-solid fa-times"></i>
                    <span>Close</span>
                </button>
                <button class="modal-btn modal-btn-confirm" id="installUpdateBtn" style="display: none;">
                    <i class="fa-solid fa-download"></i>
                    <span>Install Update</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="custom-modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <i class="fa-solid fa-trash-can modal-icon" style="color: #f44336;"></i>
                <h3 class="modal-title">Delete Task</h3>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this task?</p>
                <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" id="deleteModalCancel">
                    <i class="fa-solid fa-times"></i>
                    <span>Cancel</span>
                </button>
                <button class="modal-btn modal-btn-confirm" id="deleteModalConfirm" style="background: #f44336;">
                    <i class="fa-solid fa-trash"></i>
                    <span>Delete</span>
                </button>
            </div>
        </div>
    </div>

    <div id="rebootModal" class="custom-modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <i class="fa-solid fa-power-off modal-icon"></i>
                <h3 class="modal-title">Reboot System</h3>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to reboot the ElivateOne system?</p>
                <p style="color: #FFC107; margin-top: 1rem;">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                    This will temporarily interrupt irrigation operations.
                </p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" id="rebootModalCancel">
                    <i class="fa-solid fa-times"></i>
                    <span>Cancel</span>
                </button>
                <button class="modal-btn modal-btn-confirm" id="confirmRebootBtn">
                    <i class="fa-solid fa-power-off"></i>
                    <span>Reboot Now</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Irrigation Configuration Modal -->
    <div id="irrigationConfigModal" class="custom-modal" style="display: none;">
        <div class="modal-overlay" onclick="closeIrrigationConfig()"></div>
        <div class="modal-content config-modal-content">
            <div class="modal-header">
                <i class="fa-solid fa-gear modal-icon"></i>
                <h3 class="modal-title">Irrigation System Configuration</h3>
                <button class="modal-close-btn" onclick="closeIrrigationConfig()">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="modal-body config-modal-body">
                <form id="irrigation-config-form">
                    <div class="config-section">
                        <h4><i class="fa-solid fa-seedling"></i> Plant Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Plant Type</label>
                                <select id="config-plant-type" required>
                                    <option value="">Select Plant Type</option>
                                    <option value="vegetables">Vegetables</option>
                                    <option value="fruits">Fruits</option>
                                    <option value="flowers">Flowers</option>
                                    <option value="herbs">Herbs</option>
                                    <option value="grass">Grass/Lawn</option>
                                    <option value="trees">Trees</option>
                                    <option value="mixed">Mixed Plants</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Plant Age</label>
                                <select id="config-plant-age">
                                    <option value="seedling">Seedling (0-2 weeks)</option>
                                    <option value="young">Young (2-8 weeks)</option>
                                    <option value="mature">Mature (2+ months)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-section">
                        <h4><i class="fa-solid fa-droplet"></i> Water Resources</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Available Water (Liters/Day)</label>
                                <input type="number" id="config-water-available" min="0" placeholder="e.g., 500" required>
                            </div>
                            <div class="form-group">
                                <label>Water Pressure (Bar)</label>
                                <input type="number" id="config-water-pressure" min="0" step="0.1" placeholder="e.g., 2.5">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Water Source</label>
                            <select id="config-water-source">
                                <option value="municipal">Municipal Water</option>
                                <option value="well">Well</option>
                                <option value="rainwater">Rainwater Collection</option>
                                <option value="mixed">Mixed Sources</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="config-section">
                        <h4><i class="fa-solid fa-map"></i> Zone Configuration</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Number of Zones</label>
                                <input type="number" id="config-zone-count" min="1" max="8" value="4" required>
                            </div>
                            <div class="form-group">
                                <label>Total Area (m²)</label>
                                <input type="number" id="config-total-area" min="0" placeholder="e.g., 100">
                            </div>
                        </div>
                        <div id="zone-details-container">
                            <!-- Zone details will be dynamically generated -->
                        </div>
                    </div>
                    
                    <div class="config-section">
                        <h4><i class="fa-solid fa-cloud-sun"></i> Environmental Settings</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Soil Type</label>
                                <select id="config-soil-type">
                                    <option value="clay">Clay</option>
                                    <option value="sandy">Sandy</option>
                                    <option value="loamy">Loamy</option>
                                    <option value="silty">Silty</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Sun Exposure</label>
                                <select id="config-sun-exposure">
                                    <option value="full">Full Sun (6+ hours)</option>
                                    <option value="partial">Partial Sun (3-6 hours)</option>
                                    <option value="shade">Shade (< 3 hours)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="closeIrrigationConfig()">
                            <i class="fa-solid fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn-primary">
                            <i class="fa-solid fa-save"></i> Save Configuration
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Irrigation Tasks Calendar Modal -->
    <div id="tasksCalendarModal" class="custom-modal" style="display: none;">
        <div class="modal-overlay" onclick="closeTasksCalendar()"></div>
        <div class="modal-content calendar-modal-content">
            <div class="modal-header">
                <i class="fa-solid fa-calendar-days modal-icon"></i>
                <h3 class="modal-title">Irrigation Tasks Calendar</h3>
                <button class="modal-close-btn" onclick="closeTasksCalendar()">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="modal-body calendar-modal-body">
                <!-- Calendar View -->
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="calendar-nav-btn" onclick="previousMonth()">
                            <i class="fa-solid fa-chevron-left"></i>
                        </button>
                        <h3 id="calendar-month-year">January 2026</h3>
                        <button class="calendar-nav-btn" onclick="nextMonth()">
                            <i class="fa-solid fa-chevron-right"></i>
                        </button>
                    </div>
                    <div class="calendar-grid">
                        <div class="calendar-day-header">Sun</div>
                        <div class="calendar-day-header">Mon</div>
                        <div class="calendar-day-header">Tue</div>
                        <div class="calendar-day-header">Wed</div>
                        <div class="calendar-day-header">Thu</div>
                        <div class="calendar-day-header">Fri</div>
                        <div class="calendar-day-header">Sat</div>
                        <!-- Calendar days will be generated by JavaScript -->
                        <div id="calendar-days"></div>
                    </div>
                </div>
                
                <!-- Task Form -->
                <div class="task-form-container">
                    <h4><i class="fa-solid fa-plus-circle"></i> Add/Edit Irrigation Task</h4>
                    <form id="task-form" onsubmit="saveTask(event)">
                        <div class="form-group">
                            <label>Task Name</label>
                            <input type="text" id="task-name" placeholder="e.g., Water Zone 1" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Date</label>
                                <input type="date" id="task-date" required>
                            </div>
                            <div class="form-group">
                                <label>Time</label>
                                <input type="time" id="task-time" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Zone</label>
                            <select id="task-zone" required>
                                <option value="">Select Zone</option>
                                <option value="zone1">Zone 1</option>
                                <option value="zone2">Zone 2</option>
                                <option value="zone3">Zone 3</option>
                                <option value="zone4">Zone 4</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Duration (minutes)</label>
                            <input type="number" id="task-duration" min="1" max="120" placeholder="30" required>
                        </div>
                        <div class="form-group">
                            <label>Repeat</label>
                            <select id="task-repeat">
                                <option value="none">No Repeat</option>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn-secondary" onclick="clearTaskForm()">
                                <i class="fa-solid fa-eraser"></i> Clear
                            </button>
                            <button type="submit" class="btn-primary">
                                <i class="fa-solid fa-save"></i> Save Task
                            </button>
                        </div>
                    </form>
                    
                    <!-- Tasks List -->
                    <div class="tasks-list-container">
                        <h4><i class="fa-solid fa-list"></i> Scheduled Tasks</h4>
                        <div id="tasks-list" class="tasks-list">
                            <!-- Tasks will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Professional AI Assistant Chat Modal -->
    <div id="irrigationChatModal" class="custom-modal" style="display: none;">
        <div class="modal-overlay" onclick="closeIrrigationChat()"></div>
        <div class="modal-content professional-chat-modal">
            <div class="chat-header">
                <div class="chat-header-left">
                    <div class="chat-icon">
                        <img src="TIONESETUP.png" alt="TiOne Logo" class="chat-logo">
                    </div>
                    <div class="chat-title-section">
                        <h3 class="chat-title">Context-aware agricultural assistance with our logo</h3>
                        <div class="chat-subtitle">AI-powered irrigation management</div>
                    </div>
                </div>
                <div class="chat-header-right">
                    <div class="model-selector-container">
                        <label for="modelSelect" class="model-label">AI Model:</label>
                        <select id="modelSelect" class="model-select">
                            <option value="anthropic/claude-3-5-sonnet-20241022">Claude 3.5 Sonnet (Best for Analysis)</option>
                            <option value="openai/gpt-4o-2024-11-20">GPT-4o (Versatile)</option>
                            <option value="google/gemini-pro-1.5">Gemini Pro 1.5 (Technical)</option>
                            <option value="meta-llama/llama-3.1-70b-instruct">Llama 3.1 70B (Agricultural)</option>
                            <option value="mistralai/mistral-large-2407">Mistral Large (Specialized)</option>
                        </select>
                    </div>
                    <button class="chat-close-btn" onclick="closeIrrigationChat()">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="chat-body">
                <div class="context-panel">
                    <div class="context-header">
                        <i class="fa-solid fa-info-circle"></i>
                        <span>System Context</span>
                        <button class="context-toggle" onclick="toggleContextPanel()">
                            <i class="fa-solid fa-chevron-up"></i>
                        </button>
                    </div>
                    <div class="context-content" id="contextContent">
                        <div class="context-item">
                            <strong>Current Zone:</strong> <span id="currentZone">Zone 1</span>
                        </div>
                        <div class="context-item">
                            <strong>Soil Moisture:</strong> <span id="soilMoisture">65%</span>
                        </div>
                        <div class="context-item">
                            <strong>Weather:</strong> <span id="weatherCondition">Sunny, 24°C</span>
                        </div>
                        <div class="context-item">
                            <strong>Last Watering:</strong> <span id="lastWatering">2 hours ago</span>
                        </div>
                        <div class="context-item">
                            <strong>Crop Type:</strong> <span id="cropType">Mixed Vegetables</span>
                        </div>
                    </div>
                </div>
                
                <div class="chat-messages-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-message assistant-message">
                            <div class="message-avatar">
                                <i class="fa-solid fa-leaf"></i>
                            </div>
                            <div class="message-content">
                                <div class="message-header">
                                    <span class="message-sender">AI Plant Expert</span>
                                    <span class="message-model" id="currentModel">Claude 3.5 Sonnet</span>
                                </div>
                                <div class="message-text">
                                    Hello! I'm your AI agricultural assistant with access to your system's real-time data. I can provide context-aware advice on:
                                    <br><br>
                                    • <strong>Irrigation scheduling</strong> based on soil moisture and weather
                                    • <strong>Plant care recommendations</strong> for your specific crops
                                    • <strong>Problem diagnosis</strong> using sensor data
                                    • <strong>Optimization strategies</strong> for water and energy efficiency
                                    <br><br>
                                    What would you like to know about your irrigation system?
                                </div>
                                <div class="message-time">${new Date().toLocaleTimeString()}</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="quick-actions-panel">
                    <div class="quick-actions-header">
                        <i class="fa-solid fa-bolt"></i>
                        <span>Quick Actions</span>
                    </div>
                    <div class="quick-actions-grid">
                        <button class="quick-action-btn" onclick="askContextualQuestion('schedule')">
                            <i class="fa-solid fa-calendar-days"></i>
                            <div class="action-content">
                                <span class="action-title">Optimize Schedule</span>
                                <span class="action-desc">Based on current conditions</span>
                            </div>
                        </button>
                        <button class="quick-action-btn" onclick="askContextualQuestion('diagnosis')">
                            <i class="fa-solid fa-stethoscope"></i>
                            <div class="action-content">
                                <span class="action-title">Diagnose Issues</span>
                                <span class="action-desc">Analyze sensor data</span>
                            </div>
                        </button>
                        <button class="quick-action-btn" onclick="askContextualQuestion('weather')">
                            <i class="fa-solid fa-cloud-sun"></i>
                            <div class="action-content">
                                <span class="action-title">Weather Adjustments</span>
                                <span class="action-desc">Adapt to forecast</span>
                            </div>
                        </button>
                        <button class="quick-action-btn" onclick="askContextualQuestion('efficiency')">
                            <i class="fa-solid fa-chart-line"></i>
                            <div class="action-content">
                                <span class="action-title">Efficiency Tips</span>
                                <span class="action-desc">Save water & energy</span>
                            </div>
                        </button>
                    </div>
                </div>
                
                <div class="chat-input-section">
                    <div class="input-container">
                        <div class="input-wrapper">
                            <textarea id="chatInput" placeholder="Ask me anything about your plants, irrigation, or system optimization..." rows="1"></textarea>
                            <div class="input-actions">
                                <button class="attachment-btn" title="Include system data">
                                    <i class="fa-solid fa-paperclip"></i>
                                </button>
                                <button class="send-btn" onclick="sendChatMessage()" id="sendBtn">
                                    <i class="fa-solid fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                        <div class="input-footer">
                            <div class="typing-indicator" id="typingIndicator" style="display: none;">
                                <span class="typing-dots">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </span>
                                <span class="typing-text">AI is thinking...</span>
                            </div>
                            <div class="input-info">
                                <span class="context-indicator">
                                    <i class="fa-solid fa-database"></i>
                                    System data included
                                </span>
                                <span class="model-indicator" id="modelIndicator">Claude 3.5 Sonnet</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/dashboard.js?v=4.0"></script>
    <script src="js/space.js"></script>
    <script src="js/valve-stats.js?v=1.0"></script>
    <script src="js/language.js?v=1.0"></script>
    
    <script>
        // Show loader on page load
        window.addEventListener('load', function() {
            const loader = document.getElementById('globalLoader');
            if (loader) {
                setTimeout(() => {
                    loader.classList.add('hidden');
                }, 500);
            }
        });
        
        // Calendar functionality
        let currentDate = new Date();
        let selectedDate = null;
        let tasks = [];
        
        // Open calendar modal
        function openTasksCalendar() {
            document.getElementById('tasksCalendarModal').style.display = 'flex';
            renderCalendar();
            loadTasks();
        }
        
        // Close calendar modal
        function closeTasksCalendar() {
            document.getElementById('tasksCalendarModal').style.display = 'none';
        }
        
        // Render calendar
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('calendar-month-year').textContent = 
                new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const calendarDays = document.getElementById('calendar-days');
            calendarDays.innerHTML = '';
            
            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day empty';
                calendarDays.appendChild(emptyCell);
            }
            
            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                dayCell.textContent = day;
                
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const tasksOnDay = tasks.filter(t => t.date === dateStr);
                
                if (tasksOnDay.length > 0) {
                    dayCell.classList.add('has-tasks');
                    const badge = document.createElement('span');
                    badge.className = 'task-badge';
                    badge.textContent = tasksOnDay.length;
                    dayCell.appendChild(badge);
                }
                
                const today = new Date();
                if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                    dayCell.classList.add('today');
                }
                
                dayCell.onclick = () => selectDate(dateStr, dayCell);
                calendarDays.appendChild(dayCell);
            }
        }
        
        function selectDate(dateStr, element) {
            document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
            element.classList.add('selected');
            selectedDate = dateStr;
            document.getElementById('task-date').value = dateStr;
        }
        
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }
        
        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }
        
        function saveTask(event) {
            event.preventDefault();
            
            const form = document.getElementById('task-form');
            const editingId = form.dataset.editingId;
            
            if (editingId) {
                // Update existing task
                const taskIndex = tasks.findIndex(t => t.id == editingId);
                if (taskIndex !== -1) {
                    tasks[taskIndex] = {
                        id: parseInt(editingId),
                        name: document.getElementById('task-name').value,
                        date: document.getElementById('task-date').value,
                        time: document.getElementById('task-time').value,
                        zone: document.getElementById('task-zone').value,
                        duration: document.getElementById('task-duration').value,
                        repeat: document.getElementById('task-repeat').value
                    };
                    showNotification('Task updated successfully!', 'success');
                }
                delete form.dataset.editingId;
            } else {
                // Create new task
                const task = {
                    id: Date.now(),
                    name: document.getElementById('task-name').value,
                    date: document.getElementById('task-date').value,
                    time: document.getElementById('task-time').value,
                    zone: document.getElementById('task-zone').value,
                    duration: document.getElementById('task-duration').value,
                    repeat: document.getElementById('task-repeat').value
                };
                tasks.push(task);
                showNotification('Task saved successfully!', 'success');
            }
            
            localStorage.setItem('irrigation_tasks', JSON.stringify(tasks));
            
            clearTaskForm();
            renderCalendar();
            loadTasks();
        }
        
        function clearTaskForm() {
            const form = document.getElementById('task-form');
            form.reset();
            delete form.dataset.editingId;
            
            // Reset button text to "Save Task"
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fa-solid fa-save"></i> Save Task';
            }
        }
        
        async function loadTasks() {
            // Load tasks from localStorage
            const stored = localStorage.getItem('irrigation_tasks');
            if (stored) {
                tasks = JSON.parse(stored);
            }
            
            // Also load schedules from backend/setup
            try {
                const response = await fetch('/api/schedules');
                if (response.ok) {
                    const data = await response.json();
                    const schedules = data.data || data;
                    
                    console.log('Loaded schedules from backend:', schedules);
                    
                    // Convert schedules to tasks format for calendar display
                    if (Array.isArray(schedules)) {
                        schedules.forEach(schedule => {
                            if (schedule.enabled) {
                                // Create task entries for the next 30 days based on days_of_week
                                const daysOfWeek = schedule.days_of_week ? schedule.days_of_week.split(',') : [];
                                const today = new Date();
                                
                                for (let i = 0; i < 30; i++) {
                                    const date = new Date(today);
                                    date.setDate(today.getDate() + i);
                                    const dayName = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][date.getDay()];
                                    
                                    if (daysOfWeek.includes(dayName)) {
                                        const dateStr = date.toISOString().split('T')[0];
                                        const existingTask = tasks.find(t => 
                                            t.date === dateStr && 
                                            t.time === schedule.start_time && 
                                            t.name === schedule.name
                                        );
                                        
                                        if (!existingTask) {
                                            tasks.push({
                                                id: `schedule-${schedule.id}-${dateStr}`,
                                                name: schedule.name,
                                                date: dateStr,
                                                time: schedule.start_time,
                                                zone: `Zone ${schedule.zone_id || 1}`,
                                                duration: Math.floor(schedule.duration / 60) || 30,
                                                repeat: 'weekly',
                                                fromSchedule: true
                                            });
                                        }
                                    }
                                }
                            }
                        });
                    }
                }
            } catch (error) {
                console.log('Could not load schedules from backend:', error);
            }
            
            // Update tasks count on main dashboard
            const tasksCount = document.getElementById('tasks-count');
            if (tasksCount) {
                const upcomingCount = tasks.filter(task => {
                    const taskDate = new Date(task.date);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    return taskDate >= today;
                }).length;
                tasksCount.textContent = upcomingCount;
            }
            
            const tasksList = document.getElementById('tasks-list');
            if (!tasksList) return;
            
            tasksList.innerHTML = '';
            
            if (tasks.length === 0) {
                tasksList.innerHTML = '<p class="no-tasks">No tasks scheduled. Create a task or check your irrigation schedules.</p>';
                return;
            }
            
            tasks.sort((a, b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time));
            
            // Show only upcoming tasks (next 30 days)
            const today = new Date();
            const futureDate = new Date();
            futureDate.setDate(today.getDate() + 30);
            
            const upcomingTasks = tasks.filter(task => {
                const taskDate = new Date(task.date);
                const today = new Date();
                const futureDate = new Date();
                futureDate.setDate(today.getDate() + 30);
                return taskDate >= today && taskDate <= futureDate;
            });
            
            if (upcomingTasks.length === 0) {
                tasksList.innerHTML = '<p class="no-tasks">No upcoming tasks in the next 30 days</p>';
                return;
            }
            
            upcomingTasks.forEach(task => {
                const taskDiv = document.createElement('div');
                taskDiv.className = 'task-item';
                taskDiv.innerHTML = `
                    <div class="task-icon">
                        <i class="fa-solid fa-droplet"></i>
                    </div>
                    <div class="task-details">
                        <div class="task-name">${task.name}</div>
                        <div class="task-meta">
                            <span class="task-meta-item">
                                <i class="fa-solid fa-calendar"></i>
                                ${task.date}
                            </span>
                            <span class="task-meta-item">
                                <i class="fa-solid fa-clock"></i>
                                ${task.time}
                            </span>
                            <span class="task-meta-item">
                                <i class="fa-solid fa-hourglass"></i>
                                ${task.duration} min
                            </span>
                        </div>
                    </div>
                    <span class="task-zone-badge">${task.zone}</span>
                    <div class="task-actions">
                        ${!task.fromSchedule ? `
                            <button class="task-action-btn" onclick="editTask(${task.id})" title="Edit Task">
                                <i class="fa-solid fa-edit"></i>
                            </button>
                            <button class="task-action-btn delete" onclick="deleteTask(${task.id})" title="Delete Task">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        ` : '<span style="color: #666; font-size: 0.85rem;">Auto</span>'}
                    </div>
                `;
                tasksList.appendChild(taskDiv);
            });
        }
        
        function editTask(taskId) {
            const task = tasks.find(t => t.id == taskId);
            if (!task) return;
            
            // Populate form with task data
            document.getElementById('task-name').value = task.name;
            document.getElementById('task-date').value = task.date;
            document.getElementById('task-time').value = task.time;
            document.getElementById('task-zone').value = task.zone;
            document.getElementById('task-duration').value = task.duration;
            document.getElementById('task-repeat').value = task.repeat || 'none';
            
            // Set editing mode
            const form = document.getElementById('task-form');
            form.dataset.editingId = taskId;
            
            // Change button text
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fa-solid fa-save"></i> Update Task';
            }
            
            // Scroll to form
            document.querySelector('.task-form-container').scrollIntoView({ behavior: 'smooth' });
            
            showNotification('Edit task and click Update to save changes', 'info');
        }
        
        function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                tasks = tasks.filter(t => t.id !== taskId);
                localStorage.setItem('irrigation_tasks', JSON.stringify(tasks));
                renderCalendar();
                loadTasks();
                showNotification('Task deleted successfully!', 'success');
            }
        }
        
        // Toggle tasks preview list
        document.getElementById('tasks-scheduled-toggle')?.addEventListener('click', function() {
            const previewList = document.getElementById('tasks-preview-list');
            const toggleIcon = this.querySelector('.toggle-icon');
            
            if (previewList.style.display === 'none') {
                previewList.style.display = 'block';
                this.classList.add('expanded');
                updateTasksPreview();
            } else {
                previewList.style.display = 'none';
                this.classList.remove('expanded');
            }
        });
        
        // Update tasks preview list
        function updateTasksPreview() {
            const previewItems = document.getElementById('tasks-preview-items');
            if (!previewItems) return;
            
            previewItems.innerHTML = '';
            
            // Get upcoming tasks (next 7 days)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const futureDate = new Date();
            futureDate.setDate(today.getDate() + 7);
            
            const upcomingTasks = tasks.filter(task => {
                const taskDate = new Date(task.date);
                return taskDate >= today && taskDate <= futureDate;
            }).slice(0, 5); // Show max 5 tasks
            
            if (upcomingTasks.length === 0) {
                previewItems.innerHTML = '<p style="text-align: center; color: #999; padding: 1rem;">No upcoming tasks in the next 7 days</p>';
                return;
            }
            
            upcomingTasks.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = 'task-preview-item';
                taskItem.innerHTML = `
                    <div class="task-preview-icon">
                        <i class="fa-solid fa-droplet"></i>
                    </div>
                    <div class="task-preview-details">
                        <div class="task-preview-name">${task.name}</div>
                        <div class="task-preview-meta">
                            <span><i class="fa-solid fa-calendar"></i> ${task.date}</span>
                            <span><i class="fa-solid fa-clock"></i> ${task.time}</span>
                            <span><i class="fa-solid fa-hourglass"></i> ${task.duration} min</span>
                        </div>
                    </div>
                    <div class="task-preview-zone">${task.zone}</div>
                `;
                previewItems.appendChild(taskItem);
            });
        }
        
        // Initialize tasks on page load
        loadTasks();
        
        // Open irrigation configuration modal
        function openIrrigationConfig() {
            const modal = document.getElementById('irrigationConfigModal');
            if (modal) {
                modal.style.display = 'flex';
                loadIrrigationConfig();
            }
        }
        
        // Close irrigation configuration modal
        function closeIrrigationConfig() {
            const modal = document.getElementById('irrigationConfigModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Load saved irrigation configuration
        function loadIrrigationConfig() {
            const config = JSON.parse(localStorage.getItem('irrigation_config') || '{}');
            
            if (config.plantType) document.getElementById('config-plant-type').value = config.plantType;
            if (config.plantAge) document.getElementById('config-plant-age').value = config.plantAge;
            if (config.waterAvailable) document.getElementById('config-water-available').value = config.waterAvailable;
            if (config.waterPressure) document.getElementById('config-water-pressure').value = config.waterPressure;
            if (config.waterSource) document.getElementById('config-water-source').value = config.waterSource;
            if (config.zoneCount) document.getElementById('config-zone-count').value = config.zoneCount;
            if (config.totalArea) document.getElementById('config-total-area').value = config.totalArea;
            if (config.soilType) document.getElementById('config-soil-type').value = config.soilType;
            if (config.sunExposure) document.getElementById('config-sun-exposure').value = config.sunExposure;
        }
        
        // Save irrigation configuration
        document.getElementById('irrigation-config-form')?.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const config = {
                plantType: document.getElementById('config-plant-type').value,
                plantAge: document.getElementById('config-plant-age').value,
                waterAvailable: document.getElementById('config-water-available').value,
                waterPressure: document.getElementById('config-water-pressure').value,
                waterSource: document.getElementById('config-water-source').value,
                zoneCount: document.getElementById('config-zone-count').value,
                totalArea: document.getElementById('config-total-area').value,
                soilType: document.getElementById('config-soil-type').value,
                sunExposure: document.getElementById('config-sun-exposure').value,
                updatedAt: new Date().toISOString()
            };
            
            localStorage.setItem('irrigation_config', JSON.stringify(config));
            showNotification('Irrigation configuration saved successfully!', 'success');
            closeIrrigationConfig();
        });
        
        // Bind irrigation config button
        document.getElementById('irrigation-config-btn')?.addEventListener('click', openIrrigationConfig);
        
        // Bind calendar icon click
        document.getElementById('tasks-toggle-card')?.addEventListener('click', openTasksCalendar);
        document.getElementById('add-schedule-btn')?.addEventListener('click', openTasksCalendar);
        document.getElementById('update-schedule-btn')?.addEventListener('click', () => {
            openTasksCalendar();
            loadTasks(); // Refresh tasks when clicking update
            showNotification('Calendar updated with latest schedules', 'success');
        });
        
        // Drag and Drop Functionality
        let dragEnabled = false;
        let draggedElement = null;
        
        function toggleDragMode() {
            dragEnabled = !dragEnabled;
            const toggleBtn = document.getElementById('dragToggleBtn');
            const draggableCards = document.querySelectorAll('.sensor-card, .control-card, .chart-card, .status-card, .tasks-calendar-card');
            
            if (dragEnabled) {
                toggleBtn.classList.add('active');
                toggleBtn.style.background = 'rgba(0, 0, 0, 0.3)';
                showNotification('Drag & Drop Mode Enabled - Rearrange your dashboard!', 'info');
                
                draggableCards.forEach(card => {
                    card.setAttribute('draggable', 'true');
                    card.classList.add('draggable-active');
                    
                    card.addEventListener('dragstart', handleDragStart);
                    card.addEventListener('dragend', handleDragEnd);
                    card.addEventListener('dragover', handleDragOver);
                    card.addEventListener('drop', handleDrop);
                    card.addEventListener('dragenter', handleDragEnter);
                    card.addEventListener('dragleave', handleDragLeave);
                });
            } else {
                toggleBtn.classList.remove('active');
                toggleBtn.style.background = '';
                showNotification('Drag & Drop Mode Disabled', 'info');
                
                draggableCards.forEach(card => {
                    card.setAttribute('draggable', 'false');
                    card.classList.remove('draggable-active', 'drag-over');
                    
                    card.removeEventListener('dragstart', handleDragStart);
                    card.removeEventListener('dragend', handleDragEnd);
                    card.removeEventListener('dragover', handleDragOver);
                    card.removeEventListener('drop', handleDrop);
                    card.removeEventListener('dragenter', handleDragEnter);
                    card.removeEventListener('dragleave', handleDragLeave);
                });
            }
        }
        
        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }
        
        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(card => {
                card.classList.remove('drag-over');
            });
        }
        
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        function handleDragEnter(e) {
            if (this !== draggedElement) {
                this.classList.add('drag-over');
            }
        }
        
        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }
        
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedElement !== this) {
                const parent = this.parentNode;
                const draggedIndex = Array.from(parent.children).indexOf(draggedElement);
                const targetIndex = Array.from(parent.children).indexOf(this);
                
                if (draggedIndex < targetIndex) {
                    parent.insertBefore(draggedElement, this.nextSibling);
                } else {
                    parent.insertBefore(draggedElement, this);
                }
                
                saveDashboardLayout();
            }
            
            this.classList.remove('drag-over');
            return false;
        }
        
        function saveDashboardLayout() {
            const layout = {};
            
            // Save sensor grid layout
            const sensorGrid = document.querySelector('.sensor-grid');
            if (sensorGrid) {
                layout.sensorGrid = Array.from(sensorGrid.children).map(card => card.className);
            }
            
            // Save control section layout
            const controlSection = document.querySelector('.control-section-space');
            if (controlSection) {
                layout.controlSection = Array.from(controlSection.children).map(card => card.className);
            }
            
            // Save charts grid layout
            const chartsGrid = document.querySelector('.charts-grid-space');
            if (chartsGrid) {
                layout.chartsGrid = Array.from(chartsGrid.children).map(card => card.className);
            }
            
            // Save status activity grid layout
            const statusGrid = document.querySelector('.status-activity-grid');
            if (statusGrid) {
                layout.statusGrid = Array.from(statusGrid.children).map(card => card.className);
            }
            
            localStorage.setItem('dashboard_layout', JSON.stringify(layout));
            showNotification('Dashboard layout saved!', 'success');
        }
        
        function loadDashboardLayout() {
            const savedLayout = localStorage.getItem('dashboard_layout');
            if (!savedLayout) return;
            
            try {
                const layout = JSON.parse(savedLayout);
                // Layout restoration logic can be added here if needed
            } catch (e) {
                console.error('Error loading dashboard layout:', e);
            }
        }
        
        // Update Header DateTime
        function updateHeaderDateTime() {
            const now = new Date();
            const timeElement = document.getElementById('header-time');
            const dateElement = document.getElementById('header-date');
            
            if (timeElement) {
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                timeElement.textContent = `${hours}:${minutes}`;
            }
            
            if (dateElement) {
                const options = { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' };
                const dateStr = now.toLocaleDateString('en-US', options);
                dateElement.textContent = dateStr;
            }
        }
        
        // Initialize clock immediately and update every second
        updateHeaderDateTime();
        setInterval(updateHeaderDateTime, 1000);
        
        // Bind drag toggle button
        document.getElementById('dragToggleBtn')?.addEventListener('click', toggleDragMode);
        
        // Load saved layout on page load
        loadDashboardLayout();
        
        // Professional Chat functionality with OpenRouter integration
        let currentModel = 'anthropic/claude-3-5-sonnet-20241022';
        let contextPanelExpanded = true;
        
        function openIrrigationChat() {
            const modal = document.getElementById('irrigationChatModal');
            if (modal) {
                modal.style.display = 'flex';
                updateSystemContext();
                initializeChatInput();
            }
        }
        
        function closeIrrigationChat() {
            const modal = document.getElementById('irrigationChatModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function toggleContextPanel() {
            const contextContent = document.getElementById('contextContent');
            const toggleBtn = document.querySelector('.context-toggle i');
            
            contextPanelExpanded = !contextPanelExpanded;
            
            if (contextPanelExpanded) {
                contextContent.style.display = 'block';
                toggleBtn.className = 'fa-solid fa-chevron-up';
            } else {
                contextContent.style.display = 'none';
                toggleBtn.className = 'fa-solid fa-chevron-down';
            }
        }
        
        function updateSystemContext() {
            // Update context with real system data
            document.getElementById('currentZone').textContent = 'Zone 1';
            document.getElementById('soilMoisture').textContent = '65%';
            document.getElementById('weatherCondition').textContent = 'Sunny, 24°C';
            document.getElementById('lastWatering').textContent = '2 hours ago';
            document.getElementById('cropType').textContent = 'Mixed Vegetables';
        }
        
        function initializeChatInput() {
            const textarea = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            
            // Auto-resize textarea
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                
                // Enable/disable send button
                sendBtn.disabled = !this.value.trim();
                sendBtn.style.opacity = this.value.trim() ? '1' : '0.5';
            });
            
            // Model selection change
            const modelSelect = document.getElementById('modelSelect');
            modelSelect.addEventListener('change', function() {
                currentModel = this.value;
                const modelName = this.options[this.selectedIndex].text.split(' (')[0];
                document.getElementById('modelIndicator').textContent = modelName;
                document.getElementById('currentModel').textContent = modelName;
            });
        }
        
        function askContextualQuestion(type) {
            let question = '';
            const systemContext = getSystemContext();
            
            switch(type) {
                case 'schedule':
                    question = `Based on my current soil moisture (${systemContext.soilMoisture}) and weather conditions (${systemContext.weather}), what's the optimal irrigation schedule for my ${systemContext.cropType}?`;
                    break;
                case 'diagnosis':
                    question = `Please analyze my system data: Soil moisture: ${systemContext.soilMoisture}, Last watering: ${systemContext.lastWatering}, Weather: ${systemContext.weather}. Are there any issues I should address?`;
                    break;
                case 'weather':
                    question = `Given the current weather conditions (${systemContext.weather}), how should I adjust my irrigation schedule for ${systemContext.cropType}?`;
                    break;
                case 'efficiency':
                    question = `How can I optimize water and energy efficiency for my ${systemContext.cropType} given current conditions: ${systemContext.soilMoisture} soil moisture, ${systemContext.weather}?`;
                    break;
            }
            
            sendMessage(question, true);
        }
        
        function getSystemContext() {
            return {
                zone: document.getElementById('currentZone').textContent,
                soilMoisture: document.getElementById('soilMoisture').textContent,
                weather: document.getElementById('weatherCondition').textContent,
                lastWatering: document.getElementById('lastWatering').textContent,
                cropType: document.getElementById('cropType').textContent
            };
        }
        
        async function sendChatMessage() {
            const textarea = document.getElementById('chatInput');
            const message = textarea.value.trim();
            if (!message) return;
            
            await sendMessage(message, false);
            textarea.value = '';
            textarea.style.height = 'auto';
        }
        
        async function sendMessage(message, isContextual) {
            const chatMessages = document.getElementById('chatMessages');
            const typingIndicator = document.getElementById('typingIndicator');
            const sendBtn = document.getElementById('sendBtn');
            
            // Add user message
            const userMessage = createUserMessage(message);
            chatMessages.appendChild(userMessage);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Show typing indicator
            typingIndicator.style.display = 'flex';
            sendBtn.disabled = true;
            
            try {
                // Prepare context for AI
                const systemContext = getSystemContext();
                const contextPrompt = `
System Context:
- Current Zone: ${systemContext.zone}
- Soil Moisture: ${systemContext.soilMoisture}
- Weather: ${systemContext.weather}
- Last Watering: ${systemContext.lastWatering}
- Crop Type: ${systemContext.cropType}

You are an expert agricultural AI assistant specializing in irrigation and plant care. Use the above system context to provide specific, actionable advice. Focus on practical recommendations based on the current conditions.

User Question: ${message}`;

                // Call OpenRouter API
                const response = await callOpenRouterAPI(contextPrompt);
                
                // Add AI response
                const aiMessage = createAIMessage(response);
                chatMessages.appendChild(aiMessage);
                
            } catch (error) {
                console.error('Chat error:', error);
                const errorMessage = createAIMessage('I apologize, but I encountered an error processing your request. Please try again or check your API configuration.');
                chatMessages.appendChild(errorMessage);
            } finally {
                typingIndicator.style.display = 'none';
                sendBtn.disabled = false;
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
        
        async function callOpenRouterAPI(prompt) {
            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${getOpenRouterAPIKey()}`,
                    'Content-Type': 'application/json',
                    'X-Title': 'TiOne Irrigation Assistant'
                },
                body: JSON.stringify({
                    model: currentModel,
                    messages: [
                        {
                            role: 'system',
                            content: 'You are an expert agricultural AI assistant specializing in smart irrigation systems, plant care, and agricultural optimization. Provide practical, actionable advice based on real-time system data.'
                        },
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    temperature: 0.7,
                    max_tokens: 1000
                })
            });
            
            if (!response.ok) {
                throw new Error(`OpenRouter API error: ${response.status}`);
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }
        
        function getOpenRouterAPIKey() {
            // In production, this should be stored securely on the backend
            return localStorage.getItem('openrouter_api_key') || 'your-api-key-here';
        }
        
        function createUserMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message user-message';
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fa-solid fa-user"></i>
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-sender">You</span>
                    </div>
                    <div class="message-text">${message}</div>
                    <div class="message-time">${new Date().toLocaleTimeString()}</div>
                </div>
            `;
            return messageDiv;
        }
        
        function createAIMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message assistant-message';
            const modelName = document.getElementById('modelSelect').options[document.getElementById('modelSelect').selectedIndex].text.split(' (')[0];
            
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fa-solid fa-leaf"></i>
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-sender">AI Plant Expert</span>
                        <span class="message-model">${modelName}</span>
                    </div>
                    <div class="message-text">${message}</div>
                    <div class="message-time">${new Date().toLocaleTimeString()}</div>
                </div>
            `;
            return messageDiv;
        }
        
        function getBotResponse(question) {
            const responses = {
                'vegetables': 'For vegetables, I recommend watering 2-3 times per week with 20-30 minutes per session. Early morning (6-8 AM) is optimal to reduce evaporation and prevent fungal diseases.',
                'daily': 'Daily water requirements vary by plant type: Vegetables need 1-2 inches per week, fruits need 1.5-2.5 inches, and herbs need 0.5-1 inch. Monitor soil moisture at 2-3 inch depth.',
                'hot weather': 'During hot weather (above 85°F), water early morning (5-7 AM) or late evening (7-9 PM). Increase frequency but reduce duration to prevent water stress.',
                'seasons': 'Seasonal adjustments: Spring - increase gradually, Summer - peak watering, Fall - reduce frequency, Winter - minimal watering. Adjust based on temperature and rainfall.'
            };
            
            const lowerQuestion = question.toLowerCase();
            for (const [key, response] of Object.entries(responses)) {
                if (lowerQuestion.includes(key)) {
                    return response;
                }
            }
            
            return 'Thank you for your question! For specific irrigation advice, I recommend checking your soil moisture levels and considering factors like plant type, weather conditions, and soil drainage. Would you like me to help you create a custom schedule?';
        }
        
        // Secondary navigation functionality
        document.getElementById('refresh-data-btn')?.addEventListener('click', function() {
            showNotification('Refreshing all dashboard data...', 'info');
            // Trigger data refresh
            setTimeout(() => {
                showNotification('Dashboard data refreshed successfully!', 'success');
            }, 2000);
        });
        
        document.getElementById('export-data-btn')?.addEventListener('click', function() {
            showNotification('Exporting dashboard data...', 'info');
            // Simulate export
            setTimeout(() => {
                showNotification('Dashboard data exported successfully!', 'success');
            }, 1500);
        });
        
        document.getElementById('fullscreen-btn')?.addEventListener('click', function() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
                this.innerHTML = '<i class="fa-solid fa-compress"></i><span>Exit Fullscreen</span>';
            } else {
                document.exitFullscreen();
                this.innerHTML = '<i class="fa-solid fa-expand"></i><span>Fullscreen</span>';
            }
        });
        
        // Global Search Functionality
        function initializeSearch() {
            const searchInput = document.getElementById('global-search');
            const searchBtn = document.getElementById('search-btn');
            const searchResults = document.getElementById('search-results');
            const searchContent = document.getElementById('search-content');
            const searchLoading = document.getElementById('search-loading');
            
            if (!searchInput || !searchBtn) return;
            
            let searchTimeout;
            
            // Search button click
            searchBtn.addEventListener('click', performSearch);
            
            // Enter key search
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
            
            // Live search as user types (with debounce)
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();
                
                if (query.length >= 2) {
                    searchTimeout = setTimeout(() => {
                        performSearch();
                    }, 300);
                } else {
                    searchResults.style.display = 'none';
                }
            });
            
            // Hide results when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.nav-search')) {
                    searchResults.style.display = 'none';
                }
            });
            
            async function performSearch() {
                const query = searchInput.value.trim();
                if (!query) return;
                
                searchResults.style.display = 'block';
                searchLoading.style.display = 'block';
                searchContent.innerHTML = '';
                
                try {
                    // Backend search API call
                    const response = await fetch('/api/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ query: query })
                    });
                    
                    const data = await response.json();
                    displaySearchResults(data.results || []);
                } catch (error) {
                    console.error('Search error:', error);
                    // Fallback to frontend-only search
                    const fallbackResults = performFrontendSearch(query);
                    displaySearchResults(fallbackResults);
                } finally {
                    searchLoading.style.display = 'none';
                }
            }
            
            function performFrontendSearch(query) {
                const results = [];
                const lowerQuery = query.toLowerCase();
                
                // Search through common options and pages
                const searchItems = [
                    {
                        title: 'AI Decision Engine',
                        description: 'Configure AI settings and decision parameters',
                        path: 'ai.html',
                        keywords: ['ai', 'decision', 'artificial', 'intelligence', 'smart', 'automation']
                    },
                    {
                        title: 'Hardware Configuration',
                        description: 'Hardware setup and sensor configuration',
                        path: 'hardware.html',
                        keywords: ['hardware', 'sensor', 'configuration', 'setup', 'device']
                    },
                    {
                        title: 'User Controls',
                        description: 'System controls and user management',
                        path: 'controls.html',
                        keywords: ['control', 'user', 'settings', 'management', 'permissions']
                    },
                    {
                        title: 'Analytics Dashboard',
                        description: 'Performance analytics and data visualization',
                        path: 'analytics.html',
                        keywords: ['analytics', 'data', 'charts', 'performance', 'statistics']
                    },
                    {
                        title: 'Emergency Controls',
                        description: 'Emergency shutdown and safety controls',
                        path: 'emergency.html',
                        keywords: ['emergency', 'safety', 'shutdown', 'stop', 'alert']
                    },
                    {
                        title: 'Water Optimization',
                        description: 'Water usage optimization and efficiency settings',
                        path: 'space.html#water',
                        keywords: ['water', 'optimization', 'efficiency', 'usage', 'conservation']
                    },
                    {
                        title: 'Solar Power Management',
                        description: 'Solar power configuration and monitoring',
                        path: 'space.html#solar',
                        keywords: ['solar', 'power', 'energy', 'battery', 'renewable']
                    },
                    {
                        title: 'Remote Access',
                        description: 'Remote monitoring and control access',
                        path: 'device-link.html',
                        keywords: ['remote', 'access', 'monitoring', 'connection', 'mobile']
                    },
                    {
                        title: 'Device Pairing',
                        description: 'Pair and link new devices',
                        path: 'device-pairing.html',
                        keywords: ['device', 'pairing', 'link', 'connect', 'setup']
                    },
                    {
                        title: 'Support & Help',
                        description: 'Help documentation and support',
                        path: 'support.html',
                        keywords: ['support', 'help', 'documentation', 'assistance', 'faq']
                    }
                ];
                
                searchItems.forEach(item => {
                    const titleMatch = item.title.toLowerCase().includes(lowerQuery);
                    const descMatch = item.description.toLowerCase().includes(lowerQuery);
                    const keywordMatch = item.keywords.some(keyword => keyword.includes(lowerQuery));
                    
                    if (titleMatch || descMatch || keywordMatch) {
                        results.push(item);
                    }
                });
                
                return results;
            }
            
            function displaySearchResults(results) {
                if (results.length === 0) {
                    searchContent.innerHTML = '<div class="search-no-results">No results found. Try different keywords.</div>';
                    return;
                }
                
                searchContent.innerHTML = results.map(item => `
                    <div class="search-item" onclick="navigateToResult('${item.path}')">
                        <div class="search-item-title">${item.title}</div>
                        <div class="search-item-description">${item.description}</div>
                        <div class="search-item-path">${item.path}</div>
                    </div>
                `).join('');
            }
            
            window.navigateToResult = function(path) {
                searchResults.style.display = 'none';
                searchInput.value = '';
                
                if (path.includes('#')) {
                    const [page, anchor] = path.split('#');
                    if (page === 'space.html' && window.location.pathname.includes('space.html')) {
                        // Same page, just scroll to anchor
                        const element = document.getElementById(anchor);
                        if (element) {
                            element.scrollIntoView({ behavior: 'smooth' });
                        }
                    } else {
                        window.location.href = path;
                    }
                } else {
                    window.location.href = path;
                }
            }
        }

        // Initialize chat functionality with proper error handling
        function initializeChatFunctionality() {
            try {
                const chatBtn = document.getElementById('irrigation-chat-btn');
                if (chatBtn) {
                    chatBtn.addEventListener('click', openIrrigationChat);
                }
                
                const chatInput = document.getElementById('chatInput');
                if (chatInput) {
                    chatInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            sendChatMessage();
                        }
                    });
                }
            } catch (error) {
                console.error('Error initializing chat functionality:', error);
            }
        }
        
        // Initialize notification system functionality
        function initializeNotificationSystem() {
            try {
                const notificationBtn = document.getElementById('notificationBtn');
                if (notificationBtn && window.notificationSystem) {
                    // Ensure click handler is properly attached
                    notificationBtn.addEventListener('click', () => {
                        window.notificationSystem.togglePanel();
                    });
                    console.log('Space page notification system initialized');
                    
                    // Add a test notification to verify system works
                    setTimeout(() => {
                        window.notificationSystem.addNotification(
                            'Notification system is now working! Click the bell icon to view notifications.',
                            'success',
                            { autoClose: true, duration: 8000 }
                        );
                    }, 2000);
                } else {
                    console.warn('Notification system not ready, retrying...');
                    setTimeout(initializeNotificationSystem, 200);
                }
            } catch (error) {
                console.error('Error initializing notification system:', error);
            }
        }

        // Initialize everything with delay to ensure DOM is ready
        setTimeout(() => {
            initializeChatFunctionality();
            initializeSearch();
            initializeNotificationSystem();
        }, 100);
    </script>
    
    <!-- Enhanced Notification System -->
    <script src="js/enhanced-notifications.js?v=1.0"></script>
    
    <!-- PDF Export System -->
    <script src="js/pdf-export.js?v=1.0"></script>
    
    <!-- Language Switch System -->
    <script src="js/language-switch.js"></script>
</body>
</html>
